
<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Tutorial 4: Instrumental Variables — Neuromatch Academy: Computational Neuroscience (instructor's version)</title>
<!-- Loaded before other Sphinx assets -->
<link href="../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link href="../../../_static/pygments.css" rel="stylesheet" type="text/css">
<link href="../../../_static/styles/sphinx-book-theme.css" rel="stylesheet" type="text/css">
<link href="../../../_static/togglebutton.css" rel="stylesheet" type="text/css">
<link href="../../../_static/copybutton.css" rel="stylesheet" type="text/css">
<link href="../../../_static/mystnb.css" rel="stylesheet" type="text/css">
<link href="../../../_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/custom.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
<script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
<script src="../../../_static/jquery.js"></script>
<script src="../../../_static/underscore.js"></script>
<script src="../../../_static/doctools.js"></script>
<script src="../../../_static/togglebutton.js"></script>
<script src="../../../_static/clipboard.min.js"></script>
<script src="../../../_static/copybutton.js"></script>
<script src="../../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
<script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
<script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
<script async="async" src="../../../_static/sphinx-thebe.js"></script>
<script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
<link href="../../../_static/nma-logo-square-4xp.png" rel="shortcut icon">
<link href="../../../genindex.html" rel="index" title="Index"/>
<link href="../../../search.html" rel="search" title="Search"/>
<link href="W3D5_Outro.html" rel="next" title="Outro"/>
<link href="W3D5_Tutorial3.html" rel="prev" title="Tutorial 3: Simultaneous fitting/regression"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="None" name="docsearch:language"/>
<!-- Google Analytics -->
</link></link></link></link></link></link></head>
<body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
<!-- Checkboxes to toggle the left sidebar -->
<input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
<label class="overlay overlay-navbar" for="__navigation">
<div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
<label class="overlay overlay-pagetoc" for="__page-toc">
<div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>
<div class="container-fluid" id="banner"></div>
<div class="container-xl">
<div class="row">
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
<div class="bd-sidebar__content">
<div class="bd-sidebar__top"><div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../../../index.html">
<!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
<img alt="logo" class="logo" src="../../../_static/nma-logo-square-4xp.png"/>
<h1 class="site-logo" id="site-title">Neuromatch Academy: Computational Neuroscience (instructor's version)</h1>
</a>
</div><form action="../../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="icon fas fa-search"></i>
<input aria-label="Search this book..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." type="search"/>
</form><nav aria-label="Main" class="bd-links" id="bd-docs-nav">
<div class="bd-toc-item active">
<ul class="nav bd-sidenav bd-sidenav__home-link">
<li class="toctree-l1">
<a class="reference internal" href="../../intro.html">
                    Introduction
                </a>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../../../tatraining/TA_Training_CN.html">
   TA Training: Computational Neuroscience (CN)
  </a>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../Schedule/schedule_intro.html">
   Schedule
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox">
<label for="toctree-checkbox-1">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../Schedule/daily_schedules.html">
     General schedule
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../Schedule/shared_calendars.html">
     Shared calendars
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../Schedule/timezone_widget.html">
     Timezone widget
    </a>
</li>
</ul>
</input></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../TechnicalHelp/tech_intro.html">
   Technical Help
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox">
<label for="toctree-checkbox-2">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../../TechnicalHelp/Jupyterbook.html">
     Using jupyterbook
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox">
<label for="toctree-checkbox-3">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../../TechnicalHelp/Tutorial_colab.html">
       Using Google Colab
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../TechnicalHelp/Tutorial_kaggle.html">
       Using Kaggle
      </a>
</li>
</ul>
</input></li>
<li class="toctree-l2">
<a class="reference internal" href="../../TechnicalHelp/Discord.html">
     Using discord
    </a>
</li>
</ul>
</input></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../../TechnicalHelp/Links_Policy.html">
   Quick links and policies
  </a>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../../../prereqs/ComputationalNeuroscience.html">
   Prerequisites and preparatory materials for NMA Computational Neuroscience
  </a>
</li>
</ul>
<p class="caption">
<span class="caption-text">
  Pre-reqs Refresher
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W0D0_NeuroVideoSeries/chapter_title.html">
   Neuro Video Series (W0D0)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
<label for="toctree-checkbox-4">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D0_NeuroVideoSeries/instructor/W0D0_Tutorial1.html">
     Intro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D0_NeuroVideoSeries/instructor/W0D0_Tutorial2.html">
     Human Psychophysics
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D0_NeuroVideoSeries/instructor/W0D0_Tutorial3.html">
     Behavioral Readout
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D0_NeuroVideoSeries/instructor/W0D0_Tutorial4.html">
     Live in Lab
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D0_NeuroVideoSeries/instructor/W0D0_Tutorial5.html">
     Brain Signals: Spiking Activity
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D0_NeuroVideoSeries/instructor/W0D0_Tutorial6.html">
     Brain Signals: LFP
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D0_NeuroVideoSeries/instructor/W0D0_Tutorial7.html">
     Brain Signals: EEG &amp; MEG
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D0_NeuroVideoSeries/instructor/W0D0_Tutorial8.html">
     Brain Signals: fMRI
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D0_NeuroVideoSeries/instructor/W0D0_Tutorial9.html">
     Brain Signals: Calcium Imaging
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D0_NeuroVideoSeries/instructor/W0D0_Tutorial10.html">
     Stimulus Representation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D0_NeuroVideoSeries/instructor/W0D0_Tutorial11.html">
     Neurotransmitters
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D0_NeuroVideoSeries/instructor/W0D0_Tutorial12.html">
     Neurons to Consciousness
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W0D1_PythonWorkshop1/chapter_title.html">
   Python Workshop 1 (W0D1)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
<label for="toctree-checkbox-5">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D1_PythonWorkshop1/instructor/W0D1_Tutorial1.html">
     Tutorial: LIF Neuron Part I
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W0D2_PythonWorkshop2/chapter_title.html">
   Python Workshop 2 (W0D2)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
<label for="toctree-checkbox-6">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D2_PythonWorkshop2/instructor/W0D2_Tutorial1.html">
     Tutorial 1: LIF Neuron Part II
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W0D3_LinearAlgebra/chapter_title.html">
   Linear Algebra (W0D3)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
<label for="toctree-checkbox-7">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D3_LinearAlgebra/instructor/W0D3_Tutorial1.html">
     Tutorial 1: Vectors
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D3_LinearAlgebra/instructor/W0D3_Tutorial2.html">
     Tutorial 2: Matrices
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D3_LinearAlgebra/instructor/W0D3_Tutorial3.html">
     Bonus Tutorial: Discrete Dynamical Systems
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D3_LinearAlgebra/instructor/W0D3_Outro.html">
     Outro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D3_LinearAlgebra/instructor/W0D3_DaySummary.html">
     Day Summary
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W0D4_Calculus/chapter_title.html">
   Calculus (W0D4)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
<label for="toctree-checkbox-8">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D4_Calculus/instructor/W0D4_Tutorial1.html">
     Tutorial 1: Differentiation and Integration
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D4_Calculus/instructor/W0D4_Tutorial2.html">
     Tutorial 2: Differential Equations
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D4_Calculus/instructor/W0D4_Tutorial3.html">
     Tutorial 3: Numerical Methods
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D4_Calculus/instructor/W0D4_DaySummary.html">
     Day Summary
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W0D5_Statistics/chapter_title.html">
   Statistics (W0D5)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
<label for="toctree-checkbox-9">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D5_Statistics/instructor/W0D5_Tutorial1.html">
     Tutorial 1: Probability Distributions
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D5_Statistics/instructor/W0D5_Tutorial2.html">
     Tutorial 2: Statistical Inference
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D5_Statistics/instructor/W0D5_Outro.html">
     Outro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W0D5_Statistics/instructor/W0D5_DaySummary.html">
     Day Summary
    </a>
</li>
</ul>
</li>
</ul>
<p class="caption">
<span class="caption-text">
  Intro to Modeling
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W1D1_ModelTypes/chapter_title.html">
   Model Types (W1D1)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
<label for="toctree-checkbox-10">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D1_ModelTypes/instructor/W1D1_Intro.html">
     Intro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D1_ModelTypes/instructor/W1D1_Tutorial1.html">
     Tutorial 1: “What” models
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D1_ModelTypes/instructor/W1D1_Tutorial2.html">
     Tutorial 2: “How” models
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D1_ModelTypes/instructor/W1D1_Tutorial3.html">
     Tutorial 3: “Why” models
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D1_ModelTypes/instructor/W1D1_Tutorial4.html">
     Tutorial 4: Model Discussions
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D1_ModelTypes/instructor/W1D1_Outro.html">
     Outro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D1_ModelTypes/further_reading.html">
     Suggested further readings
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D1_ModelTypes/instructor/W1D1_DaySummary.html">
     Day Summary
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W2D1_ModelingPractice/chapter_title.html">
   Modeling Practice (W2D1)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
<label for="toctree-checkbox-11">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D1_ModelingPractice/instructor/W2D1_Intro.html">
     Intro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D1_ModelingPractice/instructor/W2D1_Tutorial1.html">
     Tutorial 1: Framing the Question
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D1_ModelingPractice/instructor/W2D1_Outro.html">
     Outro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D1_ModelingPractice/instructor/W2D1_DaySummary.html">
     Day Summary
    </a>
</li>
</ul>
</li>
</ul>
<p class="caption">
<span class="caption-text">
  Machine Learning
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W1D2_ModelFitting/chapter_title.html">
   Model Fitting (W1D2)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
<label for="toctree-checkbox-12">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D2_ModelFitting/instructor/W1D2_Intro.html">
     Intro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D2_ModelFitting/instructor/W1D2_Tutorial1.html">
     Tutorial 1: Linear regression with MSE
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D2_ModelFitting/instructor/W1D2_Tutorial2.html">
     Tutorial 2: Linear regression with MLE
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D2_ModelFitting/instructor/W1D2_Tutorial3.html">
     Tutorial 3: Confidence intervals and bootstrapping
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D2_ModelFitting/instructor/W1D2_Tutorial4.html">
     Tutorial 4: Multiple linear regression and polynomial regression
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D2_ModelFitting/instructor/W1D2_Tutorial5.html">
     Tutorial 5: Model Selection: Bias-variance trade-off
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D2_ModelFitting/instructor/W1D2_Tutorial6.html">
     Tutorial 6: Model Selection: Cross-validation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D2_ModelFitting/instructor/W1D2_Outro.html">
     Outro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D2_ModelFitting/further_reading.html">
     Suggested further readings
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D2_ModelFitting/instructor/W1D2_DaySummary.html">
     Day Summary
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W1D3_GeneralizedLinearModels/chapter_title.html">
   Generalized Linear Models (W1D3)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
<label for="toctree-checkbox-13">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D3_GeneralizedLinearModels/instructor/W1D3_Intro.html">
     Intro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D3_GeneralizedLinearModels/instructor/W1D3_Tutorial1.html">
     Tutorial 1: GLMs for Encoding
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D3_GeneralizedLinearModels/instructor/W1D3_Tutorial2.html">
     Tutorial 2: Classifiers and regularizers
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D3_GeneralizedLinearModels/instructor/W1D3_Outro.html">
     Outro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D3_GeneralizedLinearModels/further_reading.html">
     Suggested further readings
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D3_GeneralizedLinearModels/instructor/W1D3_DaySummary.html">
     Day Summary
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W1D4_DimensionalityReduction/chapter_title.html">
   Dimensionality Reduction (W1D4)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/>
<label for="toctree-checkbox-14">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D4_DimensionalityReduction/instructor/W1D4_Intro.html">
     Intro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D4_DimensionalityReduction/instructor/W1D4_Tutorial1.html">
     Tutorial 1: Geometric view of data
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D4_DimensionalityReduction/instructor/W1D4_Tutorial2.html">
     Tutorial 2: Principal Component Analysis
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D4_DimensionalityReduction/instructor/W1D4_Tutorial3.html">
     Tutorial 3: Dimensionality Reduction &amp; Reconstruction
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D4_DimensionalityReduction/instructor/W1D4_Tutorial4.html">
     Tutorial 4:  Nonlinear Dimensionality Reduction
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D4_DimensionalityReduction/instructor/W1D4_Outro.html">
     Outro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D4_DimensionalityReduction/further_reading.html">
     Suggested further readings
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D4_DimensionalityReduction/instructor/W1D4_DaySummary.html">
     Day Summary
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W1D5_DeepLearning/chapter_title.html">
   Deep Learning (W1D5)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/>
<label for="toctree-checkbox-15">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D5_DeepLearning/instructor/W1D5_Intro.html">
     Intro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D5_DeepLearning/instructor/W1D5_Tutorial1.html">
     Tutorial 1: Decoding Neural Responses
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D5_DeepLearning/instructor/W1D5_Tutorial2.html">
     Tutorial 2: Convolutional Neural Networks
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D5_DeepLearning/instructor/W1D5_Tutorial3.html">
     Tutorial 3: Building and Evaluating Normative Encoding Models
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D5_DeepLearning/instructor/W1D5_Tutorial4.html">
     Bonus Tutorial: Diving Deeper into Decoding &amp; Encoding
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D5_DeepLearning/instructor/W1D5_Outro.html">
     Outro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D5_DeepLearning/further_reading.html">
     Suggested further readings
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D5_DeepLearning/instructor/W1D5_DaySummary.html">
     Day Summary
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../Bonus_Autoencoders/chapter_title.html">
   Autoencoders (Bonus)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/>
<label for="toctree-checkbox-16">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../Bonus_Autoencoders/instructor/Bonus_Intro.html">
     Intro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../Bonus_Autoencoders/instructor/Bonus_Tutorial1.html">
     Tutorial 1: Intro to Autoencoders
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../Bonus_Autoencoders/instructor/Bonus_Tutorial2.html">
     Tutorial 2: Autoencoder extensions
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../Bonus_Autoencoders/instructor/Bonus_Tutorial3.html">
     Tutorial 3: Autoencoders applications
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../Bonus_Autoencoders/instructor/Bonus_Outro.html">
     Outro
    </a>
</li>
</ul>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../../Module_WrapUps/MachineLearning.html">
   Machine Learning Wrap-Up
  </a>
</li>
</ul>
<p class="caption">
<span class="caption-text">
  Dynamical Systems
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W2D2_LinearSystems/chapter_title.html">
   Linear Systems (W2D2)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/>
<label for="toctree-checkbox-17">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D2_LinearSystems/instructor/W2D2_Intro.html">
     Intro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D2_LinearSystems/instructor/W2D2_Tutorial1.html">
     Tutorial 1: Linear dynamical systems
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D2_LinearSystems/instructor/W2D2_Tutorial2.html">
     Tutorial 2: Markov Processes
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D2_LinearSystems/instructor/W2D2_Tutorial3.html">
     Tutorial 3: Combining determinism and stochasticity
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D2_LinearSystems/instructor/W2D2_Tutorial4.html">
     Tutorial 4: Autoregressive models
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D2_LinearSystems/instructor/W2D2_Outro.html">
     Outro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D2_LinearSystems/further_reading.html">
     Suggested further readings
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D2_LinearSystems/instructor/W2D2_DaySummary.html">
     Day Summary
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W2D3_BiologicalNeuronModels/chapter_title.html">
   Biological Neuron Models (W2D3)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" type="checkbox"/>
<label for="toctree-checkbox-18">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D3_BiologicalNeuronModels/instructor/W2D3_Intro.html">
     Intro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D3_BiologicalNeuronModels/instructor/W2D3_Tutorial1.html">
     Tutorial 1: The Leaky Integrate-and-Fire (LIF) Neuron Model
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D3_BiologicalNeuronModels/instructor/W2D3_Tutorial2.html">
     Tutorial 2: Effects of Input Correlation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D3_BiologicalNeuronModels/instructor/W2D3_Tutorial3.html">
     Tutorial 3: Synaptic transmission - Models of static and dynamic synapses
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D3_BiologicalNeuronModels/instructor/W2D3_Tutorial4.html">
     Bonus Tutorial: Spike-timing dependent plasticity (STDP)
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D3_BiologicalNeuronModels/instructor/W2D3_Outro.html">
     Outro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D3_BiologicalNeuronModels/further_reading.html">
     Suggested further readings
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D3_BiologicalNeuronModels/instructor/W2D3_DaySummary.html">
     Day Summary
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W2D4_DynamicNetworks/chapter_title.html">
   Dynamic Networks (W2D4)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" type="checkbox"/>
<label for="toctree-checkbox-19">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D4_DynamicNetworks/instructor/W2D4_Intro.html">
     Intro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D4_DynamicNetworks/instructor/W2D4_Tutorial1.html">
     Tutorial 1: Neural Rate Models
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D4_DynamicNetworks/instructor/W2D4_Tutorial2.html">
     Tutorial 2: Wilson-Cowan Model
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D4_DynamicNetworks/instructor/W2D4_Tutorial3.html">
     Bonus Tutorial: Extending the Wilson-Cowan Model
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D4_DynamicNetworks/instructor/W2D4_Outro.html">
     Outro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D4_DynamicNetworks/further_reading.html">
     Suggested further readings
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D4_DynamicNetworks/instructor/W2D4_DaySummary.html">
     Day Summary
    </a>
</li>
</ul>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../../Module_WrapUps/DynamicalSystems.html">
   Dynamical Systems Wrap-Up
  </a>
</li>
</ul>
<p class="caption">
<span class="caption-text">
  Stochastic Processes
 </span>
</p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W3D1_BayesianDecisions/chapter_title.html">
   Bayesian Decisions (W3D1)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" type="checkbox"/>
<label for="toctree-checkbox-20">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D1_BayesianDecisions/instructor/W3D1_Intro.html">
     Intro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D1_BayesianDecisions/instructor/W3D1_Tutorial1.html">
     Tutorial 1: Bayes with a binary hidden state
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D1_BayesianDecisions/instructor/W3D1_Tutorial2.html">
     Tutorial 2: Bayesian inference and decisions with continuous hidden state
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D1_BayesianDecisions/instructor/W3D1_Tutorial3.html">
     Bonus Tutorial : Fitting to data
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D1_BayesianDecisions/instructor/W3D1_Outro.html">
     Outro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D1_BayesianDecisions/further_reading.html">
     Suggested further readings
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D1_BayesianDecisions/instructor/W3D1_DaySummary.html">
     Day Summary
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W3D2_HiddenDynamics/chapter_title.html">
   Hidden Dynamics (W3D2)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" type="checkbox"/>
<label for="toctree-checkbox-21">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D2_HiddenDynamics/instructor/W3D2_Intro.html">
     Intro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D2_HiddenDynamics/instructor/W3D2_Tutorial1.html">
     Tutorial 1: Sequential Probability Ratio Test
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D2_HiddenDynamics/instructor/W3D2_Tutorial2.html">
     Tutorial 2: Hidden Markov Model
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D2_HiddenDynamics/instructor/W3D2_Tutorial3.html">
     Tutorial 3: The Kalman Filter
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D2_HiddenDynamics/instructor/W3D2_Tutorial4.html">
     Bonus Tutorial 4: The Kalman Filter, part 2
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D2_HiddenDynamics/instructor/W3D2_Tutorial5.html">
     Bonus Tutorial 5: Expectation Maximization for spiking neurons
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D2_HiddenDynamics/instructor/W3D2_Outro.html">
     Outro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D2_HiddenDynamics/further_reading.html">
     Suggested further readings
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D2_HiddenDynamics/instructor/W3D2_DaySummary.html">
     Day Summary
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W3D3_OptimalControl/chapter_title.html">
   Optimal Control (W3D3)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" type="checkbox"/>
<label for="toctree-checkbox-22">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D3_OptimalControl/instructor/W3D3_Intro.html">
     Intro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D3_OptimalControl/instructor/W3D3_Tutorial1.html">
     Tutorial 1: Optimal Control for Discrete States
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D3_OptimalControl/instructor/W3D3_Tutorial2.html">
     Tutorial 2: Optimal Control for Continuous State
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D3_OptimalControl/instructor/W3D3_Outro.html">
     Outro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D3_OptimalControl/further_reading.html">
     Suggested further readings
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D3_OptimalControl/instructor/W3D3_DaySummary.html">
     Day Summary
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W3D4_ReinforcementLearning/chapter_title.html">
   Reinforcement Learning (W3D4)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-23" name="toctree-checkbox-23" type="checkbox"/>
<label for="toctree-checkbox-23">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D4_ReinforcementLearning/instructor/W3D4_Intro.html">
     Intro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D4_ReinforcementLearning/instructor/W3D4_Tutorial1.html">
     Tutorial 1: Learning to Predict
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D4_ReinforcementLearning/instructor/W3D4_Tutorial2.html">
     Tutorial 2: Learning to Act: Multi-Armed Bandits
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D4_ReinforcementLearning/instructor/W3D4_Tutorial3.html">
     Tutorial 3: Learning to Act: Q-Learning
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D4_ReinforcementLearning/instructor/W3D4_Tutorial4.html">
     Tutorial 4: Model-Based Reinforcement Learning
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D4_ReinforcementLearning/instructor/W3D4_Outro.html">
     Outro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D4_ReinforcementLearning/further_reading.html">
     Suggested further readings
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D4_ReinforcementLearning/instructor/W3D4_DaySummary.html">
     Day Summary
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 current active has-children">
<a class="reference internal" href="../chapter_title.html">
   Network Causality (W3D5)
  </a>
<input checked="" class="toctree-checkbox" id="toctree-checkbox-24" name="toctree-checkbox-24" type="checkbox"/>
<label for="toctree-checkbox-24">
<i class="fas fa-chevron-down">
</i>
</label>
<ul class="current">
<li class="toctree-l2">
<a class="reference internal" href="W3D5_Intro.html">
     Intro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="W3D5_Tutorial1.html">
     Tutorial 1: Interventions
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="W3D5_Tutorial2.html">
     Tutorial 2: Correlations
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="W3D5_Tutorial3.html">
     Tutorial 3: Simultaneous fitting/regression
    </a>
</li>
<li class="toctree-l2 current active">
<a class="current reference internal" href="#">
     Tutorial 4: Instrumental Variables
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="W3D5_Outro.html">
     Outro
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../further_reading.html">
     Suggested further readings
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="W3D5_DaySummary.html">
     Day Summary
    </a>
</li>
</ul>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../../Module_WrapUps/StochasticProcesses.html">
   Stochastic Processes Wrap-Up
  </a>
</li>
</ul>
<p class="caption">
<span class="caption-text">
  Project Booklet
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../../../projects/README.html">
   Introduction
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../../../projects/docs/project_guidance.html">
   Daily guide for projects
  </a>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../../projects/modelingsteps/intro.html">
   Modeling Step-by-Step Guide
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-25" name="toctree-checkbox-25" type="checkbox"/>
<label for="toctree-checkbox-25">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../../projects/modelingsteps/ModelingSteps_1through4.html">
     Modeling Steps 1 - 4
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../../projects/modelingsteps/ModelingSteps_5through10.html">
     Modeling Steps 5 - 10
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../../projects/modelingsteps/TrainIllusionModel.html">
     Example Model Project: the Train Illusion
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../../projects/modelingsteps/TrainIllusionDataProject.html">
     Example Data Project: the Train Illusion
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../../projects/docs/datasets_overview.html">
   Datasets
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-26" name="toctree-checkbox-26" type="checkbox"/>
<label for="toctree-checkbox-26">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../../../projects/docs/neurons.html">
     Neurons
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-27" name="toctree-checkbox-27" type="checkbox"/>
<label for="toctree-checkbox-27">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/neurons/README.html">
       Guide
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/neurons/neurons_videos.html">
       Overview videos
      </a>
</li>
</ul>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../../../projects/docs/fMRI.html">
     fMRI
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-28" name="toctree-checkbox-28" type="checkbox"/>
<label for="toctree-checkbox-28">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/fMRI/README.html">
       Guide
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/fMRI/fMRI_videos.html">
       Overview videos
      </a>
</li>
</ul>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../../../projects/docs/ECoG.html">
     ECoG
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-29" name="toctree-checkbox-29" type="checkbox"/>
<label for="toctree-checkbox-29">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/ECoG/README.html">
       Guide
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/ECoG/ECoG_videos.html">
       Overview videos
      </a>
</li>
</ul>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../../../projects/docs/behavior.html">
     Behavior
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-30" name="toctree-checkbox-30" type="checkbox"/>
<label for="toctree-checkbox-30">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/behavior/README.html">
       Guide
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/behavior/behavior_videos.html">
       Overview videos
      </a>
</li>
</ul>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../../../projects/docs/theory.html">
     Theory
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-31" name="toctree-checkbox-31" type="checkbox"/>
<label for="toctree-checkbox-31">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/theory/README.html">
       Guide
      </a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../../../projects/docs/project_templates.html">
   Project Templates
  </a>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../../projects/docs/project_2020_highlights.html">
   Projects 2020
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-32" name="toctree-checkbox-32" type="checkbox"/>
<label for="toctree-checkbox-32">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../../projects/docs/projects_2020/neurons.html">
     Neurons
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../../projects/docs/projects_2020/theory.html">
     Theory
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../../projects/docs/projects_2020/behavior.html">
     Behavior
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../../projects/docs/projects_2020/fMRI.html">
     fMRI
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../../projects/docs/projects_2020/eeg.html">
     EEG
    </a>
</li>
</ul>
</li>
</ul>
</div>
</nav></div>
<div class="bd-sidebar__bottom">
<!-- To handle the deprecated key -->
<div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>
</div>
</div>
<div id="rtd-footer-container"></div>
</div>
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
<div class="header-article row sticky-top noprint">
<div class="col py-1 d-flex header-article-main">
<div class="header-article__left">
<label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
<span class="headerbtn__icon-container">
<i class="fas fa-bars"></i>
</span>
</label>
</div>
<div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
<button aria-label="Launch interactive content" class="headerbtn menu-dropdown__trigger">
<i class="fas fa-rocket"></i>
</button>
<div class="menu-dropdown__content">
<ul>
</ul>
</div>
</div>
<button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
<span class="headerbtn__icon-container">
<i class="fas fa-expand"></i>
</span>
</button>
<div class="menu-dropdown menu-dropdown-repository-buttons">
<button aria-label="Source repositories" class="headerbtn menu-dropdown__trigger">
<i class="fab fa-github"></i>
</button>
<div class="menu-dropdown__content">
<ul>
<li>
<a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/NeuromatchAcademy/instructor-course-content" title="Source repository">
<span class="headerbtn__icon-container">
<i class="fab fa-github"></i>
</span>
<span class="headerbtn__text-container">repository</span>
</a>
</li>
<li>
<a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/NeuromatchAcademy/instructor-course-content/issues/new?title=Issue%20on%20page%20%2Ftutorials/W3D5_NetworkCausality/instructor/W3D5_Tutorial4.html&amp;body=Your%20issue%20content%20here." title="Open an issue">
<span class="headerbtn__icon-container">
<i class="fas fa-lightbulb"></i>
</span>
<span class="headerbtn__text-container">open issue</span>
</a>
</li>
</ul>
</div>
</div>
<div class="menu-dropdown menu-dropdown-download-buttons">
<button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
<i class="fas fa-download"></i>
</button>
<div class="menu-dropdown__content">
<ul>
<li>
<a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../../../_sources/tutorials/W3D5_NetworkCausality/instructor/W3D5_Tutorial4.ipynb" title="Download source file">
<span class="headerbtn__icon-container">
<i class="fas fa-file"></i>
</span>
<span class="headerbtn__text-container">.ipynb</span>
</a>
</li>
<li>
<button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
<span class="headerbtn__icon-container">
<i class="fas fa-file-pdf"></i>
</span>
<span class="headerbtn__text-container">.pdf</span>
</button>
</li>
</ul>
</div>
</div>
<label class="headerbtn headerbtn-page-toc" for="__page-toc">
<span class="headerbtn__icon-container">
<i class="fas fa-list"></i>
</span>
</label>
</div>
</div>
<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
<div class="tocsection onthispage pt-5 pb-3">
<i class="fas fa-list"></i> Contents
    </div>
<nav aria-label="Page" id="bd-toc-nav">
<ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#">
   Tutorial 4: Instrumental Variables
  </a>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#tutorial-objectives">
   Tutorial objectives
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#notebook-4-objectives">
     Notebook 4 Objectives
    </a>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#setup">
   Setup
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#figure-settings">
     Figure Settings
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#plotting-functions">
     Plotting Functions
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#helper-functions">
     Helper Functions
    </a>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-1-instrumental-variables">
   Section 1: Instrumental Variables
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#video-1-instrumental-variables">
     Video 1: Instrumental Variables
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-1-1-a-non-neuro-example-of-an-iv">
     Section 1.1: A non-neuro example of an IV
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-1-2-how-iv-works-at-high-level">
     Section 1.2: How IV works, at high level
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-1-3-iv-estimation-using-two-stage-least-squares">
     Section 1.3: IV estimation using two-stage least squares
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-1-3-1-least-squares-regression-stage-1">
       Section 1.3.1: Least squares regression stage 1
      </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#video-2-stage-1">
         Video 2: Stage 1
        </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#coding-exercise-1-3-1-compute-regression-stage-1">
         Coding Exercise 1.3.1: Compute regression stage 1
        </a>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#suggestions">
       Suggestions
      </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-1-3-2-least-squares-regression-stage-2">
       Section 1.3.2: Least squares regression stage 2
      </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#video-3-stage-2">
         Video 3: Stage 2
        </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#coding-exercise-1-3-2-compute-the-iv-estimate">
         Coding Exercise 1.3.2: Compute the IV estimate
        </a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-2-ivs-in-our-simulated-neural-system">
   Section 2: IVs in our simulated neural system
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#video-4-ivs-in-simulated-neural-systems">
     Video 4: IVs in simulated neural systems
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-2-1-simulate-a-system-with-iv">
     Section 2.1: Simulate a system with IV
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#coding-exercise-2-1-simulate-a-system-with-iv">
       Coding Exercise 2.1: Simulate a system with IV
      </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-2-2-estimate-iv-for-simulated-neural-system">
     Section 2.2: Estimate IV for simulated neural system
    </a>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-3-ivs-and-omitted-variable-bias">
   Section 3: IVs and omitted variable bias
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#video-5-iv-vs-regression">
     Video 5: IV vs regression
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#interactive-demo-3-estimating-connectivity-with-iv-vs-regression-on-a-subset-of-observed-neurons">
     Interactive Demo 3: Estimating connectivity with IV vs regression on a subset of observed neurons
    </a>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-4-thinking-about-causality-in-your-work">
   Section 4: Thinking about causality in your work
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#think-4-discussion-questions">
     Think 4!: Discussion questions
    </a>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#summary">
   Summary
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#video-6-summary">
     Video 6: Summary
    </a>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#bonus">
   Bonus
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#bonus-section-1-exploring-instrument-strength">
     Bonus Section 1: Exploring Instrument Strength
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#bonus-exercise-1-exploring-instrument-strength">
       Bonus Exercise 1: Exploring instrument strength
      </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#bonus-section-2-granger-causality">
     Bonus Section 2: Granger Causality
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#bonus-section-2-1-granger-causality-in-small-systems">
       Bonus Section 2.1: Granger causality in small systems
      </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#bonus-coding-exercise-2-1-evaluate-granger-causality">
         Bonus Coding Exercise 2.1: Evaluate Granger causality
        </a>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#bonus-section-2-2-granger-causality-in-large-systems">
       Bonus Section 2.2: Granger causality in large systems
      </a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
<div class="article row">
<div class="col pl-md-3 pl-lg-5 content-container">
<!-- Table of contents that is only displayed when printing the page -->
<div class="onlyprint" id="jb-print-docs-body">
<h1>Tutorial 4: Instrumental Variables</h1>
<!-- Table of contents -->
<div id="print-main-content">
<div id="jb-print-toc">
<div>
<h2> Contents </h2>
</div>
<nav aria-label="Page">
<ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#">
   Tutorial 4: Instrumental Variables
  </a>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#tutorial-objectives">
   Tutorial objectives
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#notebook-4-objectives">
     Notebook 4 Objectives
    </a>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#setup">
   Setup
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#figure-settings">
     Figure Settings
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#plotting-functions">
     Plotting Functions
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#helper-functions">
     Helper Functions
    </a>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-1-instrumental-variables">
   Section 1: Instrumental Variables
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#video-1-instrumental-variables">
     Video 1: Instrumental Variables
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-1-1-a-non-neuro-example-of-an-iv">
     Section 1.1: A non-neuro example of an IV
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-1-2-how-iv-works-at-high-level">
     Section 1.2: How IV works, at high level
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-1-3-iv-estimation-using-two-stage-least-squares">
     Section 1.3: IV estimation using two-stage least squares
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-1-3-1-least-squares-regression-stage-1">
       Section 1.3.1: Least squares regression stage 1
      </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#video-2-stage-1">
         Video 2: Stage 1
        </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#coding-exercise-1-3-1-compute-regression-stage-1">
         Coding Exercise 1.3.1: Compute regression stage 1
        </a>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#suggestions">
       Suggestions
      </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-1-3-2-least-squares-regression-stage-2">
       Section 1.3.2: Least squares regression stage 2
      </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#video-3-stage-2">
         Video 3: Stage 2
        </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#coding-exercise-1-3-2-compute-the-iv-estimate">
         Coding Exercise 1.3.2: Compute the IV estimate
        </a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-2-ivs-in-our-simulated-neural-system">
   Section 2: IVs in our simulated neural system
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#video-4-ivs-in-simulated-neural-systems">
     Video 4: IVs in simulated neural systems
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-2-1-simulate-a-system-with-iv">
     Section 2.1: Simulate a system with IV
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#coding-exercise-2-1-simulate-a-system-with-iv">
       Coding Exercise 2.1: Simulate a system with IV
      </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-2-2-estimate-iv-for-simulated-neural-system">
     Section 2.2: Estimate IV for simulated neural system
    </a>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-3-ivs-and-omitted-variable-bias">
   Section 3: IVs and omitted variable bias
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#video-5-iv-vs-regression">
     Video 5: IV vs regression
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#interactive-demo-3-estimating-connectivity-with-iv-vs-regression-on-a-subset-of-observed-neurons">
     Interactive Demo 3: Estimating connectivity with IV vs regression on a subset of observed neurons
    </a>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-4-thinking-about-causality-in-your-work">
   Section 4: Thinking about causality in your work
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#think-4-discussion-questions">
     Think 4!: Discussion questions
    </a>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#summary">
   Summary
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#video-6-summary">
     Video 6: Summary
    </a>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#bonus">
   Bonus
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#bonus-section-1-exploring-instrument-strength">
     Bonus Section 1: Exploring Instrument Strength
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#bonus-exercise-1-exploring-instrument-strength">
       Bonus Exercise 1: Exploring instrument strength
      </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#bonus-section-2-granger-causality">
     Bonus Section 2: Granger Causality
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#bonus-section-2-1-granger-causality-in-small-systems">
       Bonus Section 2.1: Granger causality in small systems
      </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#bonus-coding-exercise-2-1-evaluate-granger-causality">
         Bonus Coding Exercise 2.1: Evaluate Granger causality
        </a>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#bonus-section-2-2-granger-causality-in-large-systems">
       Bonus Section 2.2: Granger causality in large systems
      </a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
</div>
<main id="main-content" role="main">
<div>
<p><a href="https://colab.research.google.com/github/NeuromatchAcademy/course-content/blob/main/tutorials/W3D5_NetworkCausality/instructor/W3D5_Tutorial4.ipynb" target="_blank"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a>   <a href="https://kaggle.com/kernels/welcome?src=https://raw.githubusercontent.com/NeuromatchAcademy/course-content/main/tutorials/W3D5_NetworkCausality/instructor/W3D5_Tutorial4.ipynb" target="_blank"><img alt="Open in Kaggle" src="https://kaggle.com/static/images/open-in-kaggle.svg"/></a></p>
<div class="section" id="tutorial-4-instrumental-variables">
<h1>Tutorial 4: Instrumental Variables<a class="headerlink" href="#tutorial-4-instrumental-variables" title="Permalink to this headline">¶</a></h1>
<p><strong>Week 3, Day 5: Network Causality</strong></p>
<p><strong>By Neuromatch Academy</strong></p>
<p><strong>Content creators</strong>: Ari Benjamin, Tony Liu, Konrad Kording</p>
<p><strong>Content reviewers</strong>: Mike X Cohen, Madineh Sarvestani, Yoni Friedman, Ella Batty, Michael Waskom</p>
<p><strong>Post-production team:</strong> Gagana B, Spiros Chavlis</p>
<p align="center"><img src="https://github.com/NeuromatchAcademy/widgets/blob/master/sponsors.png?raw=True"/></p></div>
<hr class="docutils"/>
<div class="section" id="tutorial-objectives">
<h1>Tutorial objectives<a class="headerlink" href="#tutorial-objectives" title="Permalink to this headline">¶</a></h1>
<p><em>Estimated timing of tutorial: 1 hour, 5 min</em></p>
<p>This is our final tutorial on our day of examining causality. Below is the high level outline of what we’ve covered today, with the sections we will focus on in this notebook in bold:</p>
<ol class="simple">
<li><p>Master definitions of causality</p></li>
<li><p>Understand that estimating causality is possible</p></li>
<li><p>Learn 4 different methods and understand when they fail
1. perturbations
2. correlations
3. simultaneous fitting/regression
4. <strong>instrumental variables</strong></p></li>
</ol>
<div class="section" id="notebook-4-objectives">
<h2>Notebook 4 Objectives<a class="headerlink" href="#notebook-4-objectives" title="Permalink to this headline">¶</a></h2>
<p>In tutorial 3 we saw that even more sophisticated techniques such as simultaneous fitting fail to capture causality in the presence of omitted variable bias. So what techniques are there for us to obtain valid causal measurements when we can’t perturb the system? Here we will:</p>
<ul class="simple">
<li><p>learn about <strong>instrumental variables,</strong> a method that does not require experimental data for valid causal analysis</p></li>
<li><p>explore benefits of instrumental variable analysis and limitations</p>
<ul>
<li><p>addresses <strong>omitted variable bias</strong> seen in regression</p></li>
<li><p>less efficient in terms of sample size than other techniques</p></li>
<li><p>requires a particular form of randomness in the system in order for causal effects to be identified</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Tutorial slides</span>
<span class="c1"># @markdown These are the slides for the videos in all tutorials today</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">IFrame</span>
<span class="n">link_id</span> <span class="o">=</span> <span class="s2">"gp4m9"</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"If you want to download the slides: https://osf.io/download/</span><span class="si">{</span><span class="n">link_id</span><span class="si">}</span><span class="s2">/"</span><span class="p">)</span>
<span class="n">IFrame</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="sa">f</span><span class="s2">"https://mfr.ca-1.osf.io/render?url=https://osf.io/</span><span class="si">{</span><span class="n">link_id</span><span class="si">}</span><span class="s2">/?direct%26mode=render%26action=download%26mode=render"</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">854</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">480</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<hr class="docutils"/>
<div class="section" id="setup">
<h1>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Imports</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>

<span class="kn">from</span> <span class="nn">sklearn.multioutput</span> <span class="kn">import</span> <span class="n">MultiOutputRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span><span class="p">,</span> <span class="n">Lasso</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="figure-settings">
<h2>Figure Settings<a class="headerlink" href="#figure-settings" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title Figure Settings</span>
<span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">widgets</span>       <span class="c1"># interactive display</span>
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = 'retina'
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">"https://raw.githubusercontent.com/NeuromatchAcademy/course-content/main/nma.mplstyle"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="plotting-functions">
<h2>Plotting Functions<a class="headerlink" href="#plotting-functions" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Plotting Functions</span>

<span class="k">def</span> <span class="nf">see_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Visualizes the connectivity matrix.</span>

<span class="sd">    Args:</span>
<span class="sd">        A (np.ndarray): the connectivity matrix of shape (n_neurons, n_neurons)</span>
<span class="sd">        ax (plt.axis): the matplotlib axis to display on</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing, but visualizes A.</span>
<span class="sd">    """</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># make up for opposite connectivity</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">'equal'</span><span class="p">)</span>
    <span class="n">thetas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span><span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A</span> <span class="o">/</span> <span class="n">A</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">head_width</span><span class="o">=</span><span class="mf">.15</span><span class="p">,</span>
                        <span class="n">width</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="mi">25</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s1">'right'</span><span class="p">,</span> <span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">plot_neural_activity</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
<span class="w">  </span><span class="sd">"""Plot first 10 timesteps of neural activity</span>

<span class="sd">  Args:</span>
<span class="sd">    X (ndarray): neural activity (n_neurons by timesteps)</span>

<span class="sd">  """</span>
  <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
  <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">10</span><span class="p">],</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">'auto'</span><span class="p">)</span>
  <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
  <span class="n">cax1</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">"right"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">"5%"</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax1</span><span class="p">)</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">'Timestep'</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">'Neuron'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">'Simulated Neural Activity'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">compare_granger_connectivity</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">reject_null</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">):</span>
<span class="w">  </span><span class="sd">"""Plot granger connectivity vs true</span>

<span class="sd">  Args:</span>
<span class="sd">    A (ndarray): true connectivity (n_neurons by n_neurons)</span>
<span class="sd">    reject_null (list): outcome of granger causality, length n_neurons</span>
<span class="sd">    selecte_neuron (int): the neuron we are plotting connectivity from</span>

<span class="sd">  """</span>
  <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

  <span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">A</span><span class="p">[:,</span> <span class="p">[</span><span class="n">selected_neuron</span><span class="p">]],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'coolwarm'</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">'auto'</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">selected_neuron</span><span class="p">])</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s2">"True connectivity for neuron </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">selected_neuron</span><span class="p">))</span>

  <span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">reject_null</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'coolwarm'</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">'auto'</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">selected_neuron</span><span class="p">])</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s2">"Granger causality connectivity for neuron </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">selected_neuron</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">plot_performance_vs_eta</span><span class="p">(</span><span class="n">etas</span><span class="p">,</span> <span class="n">corr_data</span><span class="p">):</span>
<span class="w">  </span><span class="sd">""" Plot IV estimation performance as a function of instrument strength</span>

<span class="sd">    Args:</span>
<span class="sd">      etas (list): list of instrument strengths</span>
<span class="sd">      corr_data (ndarray): n_trials x len(etas) array where each element is the correlation</span>
<span class="sd">        between true and estimated connectivity matries for that trial and</span>
<span class="sd">        instrument strength</span>

<span class="sd">  """</span>
  <span class="n">corr_mean</span> <span class="o">=</span> <span class="n">corr_data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">corr_std</span> <span class="o">=</span> <span class="n">corr_data</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">etas</span><span class="p">,</span> <span class="n">corr_mean</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">etas</span><span class="p">,</span>
              <span class="n">corr_mean</span> <span class="o">-</span> <span class="n">corr_std</span><span class="p">,</span>
              <span class="n">corr_mean</span> <span class="o">+</span> <span class="n">corr_std</span><span class="p">,</span>
              <span class="n">alpha</span><span class="o">=</span><span class="mf">.2</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">etas</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">etas</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"IV performance as a function of instrument strength"</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Correlation b.t. IV and true connectivity"</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Strength of instrument (eta)"</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="helper-functions">
<h2>Helper Functions<a class="headerlink" href="#helper-functions" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Helper Functions</span>

<span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Compute sigmoid nonlinearity element-wise on x.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (np.ndarray): the numpy data array we want to transform</span>
<span class="sd">    Returns</span>
<span class="sd">        (np.ndarray): x with sigmoid nonlinearity applied</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">logit</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>

<span class="sd">    Applies the logit (inverse sigmoid) transformation</span>

<span class="sd">    Args:</span>
<span class="sd">        x (np.ndarray): the numpy data array we want to transform</span>
<span class="sd">    Returns</span>
<span class="sd">        (np.ndarray): x with logit nonlinearity applied</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">x</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">create_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.9</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Generate our nxn causal connectivity matrix.</span>

<span class="sd">    Args:</span>
<span class="sd">        n_neurons (int): the number of neurons in our system.</span>
<span class="sd">        random_state (int): random seed for reproducibility</span>

<span class="sd">    Returns:</span>
<span class="sd">        A (np.ndarray): our 0.1 sparse connectivity matrix</span>
<span class="sd">    """</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
    <span class="n">A_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">])</span>

    <span class="c1"># set the timescale of the dynamical system to about 100 steps</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">s_vals</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">A_0</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A_0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.01</span> <span class="o">*</span> <span class="n">s_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># _, s_val_test, _ = np.linalg.svd(A)</span>
    <span class="c1"># assert s_val_test[0] &lt; 1, "largest singular value &gt;= 1"</span>

    <span class="k">return</span> <span class="n">A</span>


<span class="k">def</span> <span class="nf">simulate_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Simulates a dynamical system for the specified number of neurons and timesteps.</span>

<span class="sd">    Args:</span>
<span class="sd">        A (np.array): the connectivity matrix</span>
<span class="sd">        timesteps (int): the number of timesteps to simulate our system.</span>
<span class="sd">        random_state (int): random seed for reproducibility</span>

<span class="sd">    Returns:</span>
<span class="sd">        - X has shape (n_neurons, timeteps).</span>
<span class="sd">    """</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>

    <span class="n">n_neurons</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">timesteps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># solution</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">))</span>
        <span class="n">X</span><span class="p">[:,</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">t</span><span class="p">])</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">epsilon</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">n_neurons</span><span class="p">,)</span>
    <span class="k">return</span> <span class="n">X</span>


<span class="k">def</span> <span class="nf">get_sys_corr</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">neuron_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    A wrapper function for our correlation calculations between A and R.</span>

<span class="sd">    Args:</span>
<span class="sd">        n_neurons (int): the number of neurons in our system.</span>
<span class="sd">        timesteps (int): the number of timesteps to simulate our system.</span>
<span class="sd">        random_state (int): seed for reproducibility</span>
<span class="sd">        neuron_idx (int): optionally provide a neuron idx to slice out</span>

<span class="sd">    Returns:</span>
<span class="sd">        A single float correlation value representing the similarity between A and R</span>
<span class="sd">    """</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">create_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">simulate_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>

    <span class="n">R</span> <span class="o">=</span> <span class="n">correlation_for_all_neurons</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">R</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">correlation_for_all_neurons</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
<span class="w">  </span><span class="sd">"""Computes the connectivity matrix for the all neurons using correlations</span>

<span class="sd">    Args:</span>
<span class="sd">        X: the matrix of activities</span>

<span class="sd">    Returns:</span>
<span class="sd">        estimated_connectivity (np.ndarray): estimated connectivity for the selected neuron, of shape (n_neurons,)</span>
<span class="sd">  """</span>
  <span class="n">n_neurons</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
  <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">S</span><span class="p">)[:</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">:]</span>
  <span class="k">return</span> <span class="n">R</span>


<span class="k">def</span> <span class="nf">print_corr</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">corrs</span><span class="p">,</span> <span class="n">idx_dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Helper function for formatting print statements for correlations"""</span>
    <span class="n">text_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'Z'</span><span class="p">:</span><span class="s1">'taxes'</span><span class="p">,</span> <span class="s1">'T'</span><span class="p">:</span><span class="s1">'# cigarettes'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">:</span><span class="s1">'SES status'</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">:</span><span class="s1">'birth weight'</span><span class="p">}</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Correlation between </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2">): </span><span class="si">{:.3f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">text_dict</span><span class="p">[</span><span class="n">v1</span><span class="p">],</span> <span class="n">text_dict</span><span class="p">[</span><span class="n">v2</span><span class="p">],</span> <span class="n">corrs</span><span class="p">[</span><span class="n">idx_dict</span><span class="p">[</span><span class="n">v1</span><span class="p">],</span> <span class="n">idx_dict</span><span class="p">[</span><span class="n">v2</span><span class="p">]]))</span>


<span class="k">def</span> <span class="nf">get_regression_estimate</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">neuron_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Estimates the connectivity matrix using lasso regression.</span>

<span class="sd">    Args:</span>
<span class="sd">        X (np.ndarray): our simulated system of shape (n_neurons, timesteps)</span>
<span class="sd">        neuron_idx (int): optionally provide a neuron idx to compute connectivity for</span>
<span class="sd">    Returns:</span>
<span class="sd">        V (np.ndarray): estimated connectivity matrix of shape (n_neurons, n_neurons).</span>
<span class="sd">                        if neuron_idx is specified, V is of shape (n_neurons,).</span>
<span class="sd">    """</span>
    <span class="n">n_neurons</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Extract Y and W as defined above</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">neuron_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">X</span><span class="p">[[</span><span class="n">neuron_idx</span><span class="p">],</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

    <span class="c1"># apply inverse sigmoid transformation</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">logit</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>

    <span class="c1"># fit multioutput regression</span>
    <span class="n">regression</span> <span class="o">=</span> <span class="n">MultiOutputRegressor</span><span class="p">(</span><span class="n">Lasso</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">),</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">regression</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">neuron_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">estimator</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">regression</span><span class="o">.</span><span class="n">estimators_</span><span class="p">):</span>
            <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">coef_</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">estimators_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span>

    <span class="k">return</span> <span class="n">V</span>


<span class="k">def</span> <span class="nf">get_regression_corr</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">random_state</span><span class="p">,</span> <span class="n">observed_ratio</span><span class="p">,</span> <span class="n">regression_args</span><span class="p">,</span> <span class="n">neuron_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    A wrapper function for our correlation calculations between A and the V estimated</span>
<span class="sd">    from regression.</span>

<span class="sd">    Args:</span>
<span class="sd">        n_neurons (int): the number of neurons in our system.</span>
<span class="sd">        timesteps (int): the number of timesteps to simulate our system.</span>
<span class="sd">        random_state (int): seed for reproducibility</span>
<span class="sd">        observed_ratio (float): the proportion of n_neurons observed, must be betweem 0 and 1.</span>
<span class="sd">        regression_args (dict): dictionary of lasso regression arguments and hyperparameters</span>
<span class="sd">        neuron_idx (int): optionally provide a neuron idx to compute connectivity for</span>

<span class="sd">    Returns:</span>
<span class="sd">        A single float correlation value representing the similarity between A and R</span>
<span class="sd">    """</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">observed_ratio</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">observed_ratio</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">create_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">simulate_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>

    <span class="n">sel_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_neurons</span><span class="o">*</span><span class="n">observed_ratio</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">)</span>

    <span class="n">sel_X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">sel_A</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:</span><span class="n">sel_idx</span><span class="p">]</span>

    <span class="n">sel_V</span> <span class="o">=</span> <span class="n">get_regression_estimate</span><span class="p">(</span><span class="n">sel_X</span><span class="p">,</span> <span class="n">neuron_idx</span><span class="o">=</span><span class="n">neuron_idx</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">neuron_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">sel_A</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">sel_V</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">sel_A</span><span class="p">[</span><span class="n">neuron_idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">sel_V</span><span class="p">)[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">get_regression_estimate_full_connectivity</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Estimates the connectivity matrix using lasso regression.</span>

<span class="sd">    Args:</span>
<span class="sd">        X (np.ndarray): our simulated system of shape (n_neurons, timesteps)</span>
<span class="sd">        neuron_idx (int): optionally provide a neuron idx to compute connectivity for</span>
<span class="sd">    Returns:</span>
<span class="sd">        V (np.ndarray): estimated connectivity matrix of shape (n_neurons, n_neurons).</span>
<span class="sd">                        if neuron_idx is specified, V is of shape (n_neurons,).</span>
<span class="sd">    """</span>
    <span class="n">n_neurons</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Extract Y and W as defined above</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

    <span class="c1"># apply inverse sigmoid transformation</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">logit</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>

    <span class="c1"># fit multioutput regression</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="n">MultiOutputRegressor</span><span class="p">(</span><span class="n">Lasso</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">200</span><span class="p">),</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">reg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>

    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">estimator</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">estimators_</span><span class="p">):</span>
        <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">coef_</span>

    <span class="k">return</span> <span class="n">V</span>


<span class="k">def</span> <span class="nf">get_regression_corr_full_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">observed_ratio</span><span class="p">,</span> <span class="n">regression_args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    A wrapper function for our correlation calculations between A and the V estimated</span>
<span class="sd">    from regression.</span>

<span class="sd">    Args:</span>
<span class="sd">        n_neurons (int): number of neurons</span>
<span class="sd">        A (np.ndarray): connectivity matrix</span>
<span class="sd">        X (np.ndarray): dynamical system</span>
<span class="sd">        observed_ratio (float): the proportion of n_neurons observed, must be betweem 0 and 1.</span>
<span class="sd">        regression_args (dict): dictionary of lasso regression arguments and hyperparameters</span>

<span class="sd">    Returns:</span>
<span class="sd">        A single float correlation value representing the similarity between A and R</span>
<span class="sd">    """</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">observed_ratio</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">observed_ratio</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">sel_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_neurons</span><span class="o">*</span><span class="n">observed_ratio</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">)</span>

    <span class="n">sel_X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">sel_A</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:</span><span class="n">sel_idx</span><span class="p">]</span>

    <span class="n">sel_V</span> <span class="o">=</span> <span class="n">get_regression_estimate_full_connectivity</span><span class="p">(</span><span class="n">sel_X</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">sel_A</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">sel_V</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">sel_V</span>
</pre></div>
</div>
</div>
</div>
<p>The helper functions defined above are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sigmoid</span></code>: computes sigmoid nonlinearity element-wise on input, from Tutorial 1</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">logit</span></code>: applies the logit (inverse sigmoid) transformation, from Tutorial 3</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">create_connectivity</span></code>: generates nxn causal connectivity matrix., from Tutorial 1</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">simulate_neurons</span></code>: simulates a dynamical system for the specified number of neurons and timesteps, from Tutorial 1</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">get_sys_corr</span></code>: a wrapper function for correlation calculations between A and R, from Tutorial 2</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">correlation_for_all_neurons</span></code>: computes the connectivity matrix for the all neurons using correlations, from Tutorial 2</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">print_corr</span></code>: formats print statements for correlations</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">get_regression_estimate</span></code>: estimates the connectivity matrix using lasso regression, from Tutorial 3</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">get_regression_corr</span></code>: a wrapper function for our correlation calculations between A and the V estimated from regression.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">get_regression_estimate_full_connectivity</span></code>: estimates the connectivity matrix using lasso regression, from Tutorial 3</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">get_regression_corr_full_connectivity</span></code>: a wrapper function for our correlation calculations between A and the V estimated from regression, from Tutorial 3</p></li>
</ul>
</div>
</div>
<hr class="docutils"/>
<div class="section" id="section-1-instrumental-variables">
<h1>Section 1: Instrumental Variables<a class="headerlink" href="#section-1-instrumental-variables" title="Permalink to this headline">¶</a></h1>
<div class="section" id="video-1-instrumental-variables">
<h2>Video 1: Instrumental Variables<a class="headerlink" href="#video-1-instrumental-variables" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_remove-input docutils container">
</div>
<p>If there is randomness naturally occurring in the system <em>that we can observe</em>, this in effect becomes the perturbations we can use to recover causal effects. This is called an <strong>instrumental variable</strong>. At high level, an instrumental variable must</p>
<ol class="simple">
<li><p>Be observable</p></li>
<li><p>Affect a covariate you care about</p></li>
<li><p><strong>Not</strong> affect the outcome, except through the covariate</p></li>
</ol>
<p>It’s rare to find these things in the wild, but when you do it’s very powerful.</p>
<figure>
<img src="https://raw.githubusercontent.com/NeuromatchAcademy/course-content/main/tutorials/W3D5_NetworkCausality/static/image_t4.png"/>
</figure></div>
<div class="section" id="section-1-1-a-non-neuro-example-of-an-iv">
<h2>Section 1.1: A non-neuro example of an IV<a class="headerlink" href="#section-1-1-a-non-neuro-example-of-an-iv" title="Permalink to this headline">¶</a></h2>
<p>A classic example is estimating the effect of smoking cigarettes while pregnant on the birth weight of the infant. There is a (negative) correlation, but is it causal? Unfortunately many confounds affect both birth weight and smoking. Wealth is a big one.</p>
<p>Instead of controlling everything imaginable, one can find an IV. Here the instrumental variable is <strong>state taxes on tobacco</strong>. These</p>
<ol class="simple">
<li><p>Are observable</p></li>
<li><p>Affect tobacco consumption</p></li>
<li><p>Don’t affect birth weight except through tobacco</p></li>
</ol>
<p>By using the power of IV techniques, you can determine the causal effect without exhaustively controlling for everything.</p>
<p>Let’s represent our tobacco example above with the following notation:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(Z_{\text{taxes}}\)</span>: our tobacco tax <strong>instrument</strong>, which only affects an individual’s tendency to smoke while pregnant within our system</p></li>
<li><p><span class="math notranslate nohighlight">\(T_{\text{smoking}}\)</span>: number of cigarettes smoked per day while pregnant, our “treatment” if this were a randomized trial</p></li>
<li><p><span class="math notranslate nohighlight">\(C_{\text{SES}}\)</span>: socioeconomic status (higher means wealthier), a <strong>confounder</strong> if it is not observed</p></li>
<li><p><span class="math notranslate nohighlight">\(Y_{\text{birthweight}}\)</span>: child birthweight in grams, our outcome of interest</p></li>
</ul>
<p>Let’s suppose we have the following function for our system:</p>
<p><span class="math notranslate nohighlight">\(Y_{\text{birthweight}} = 3000 + C_{\text{SES}} - 2T_{\text{smoking}},\)</span></p>
<p>with the additional fact that <span class="math notranslate nohighlight">\(C_{\text{SES}}\)</span> is negatively correlated with <span class="math notranslate nohighlight">\(T_{\text{smoking}}\)</span>.</p>
<p>The causal effect we wish to estimate is the coefficient <span class="math notranslate nohighlight">\(-2\)</span> for <span class="math notranslate nohighlight">\(T_{\text{smoking}}\)</span>, which means that if a mother smokes one additional cigarette per day while pregnant her baby will be 2 grams lighter at birth.</p>
<p>We’ve provided a covariance matrix with the desired structure in the code cell below, so please run it to look at the correlations between our variables.</p>
<p>Execute this cell to see correlations with C</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @markdown Execute this cell to see correlations with C</span>
<span class="c1"># run this code below to generate our setup</span>
<span class="n">idx_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'Z'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">'T'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">'C'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">'Y'</span><span class="p">:</span> <span class="mi">3</span>
<span class="p">}</span>
<span class="c1"># vars:             Z    T    C</span>
<span class="n">covar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>  <span class="c1"># Z</span>
                  <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">],</span>  <span class="c1"># T</span>
                  <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>  <span class="c1"># C</span>
<span class="c1"># vars:  Z  T  C</span>
<span class="n">means</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

<span class="c1"># generate some data</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">means</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">covar</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>

<span class="c1"># generate Y from our equation above</span>
<span class="n">Y</span> <span class="o">=</span> <span class="mi">3000</span> <span class="o">+</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">idx_dict</span><span class="p">[</span><span class="s1">'C'</span><span class="p">]]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="n">idx_dict</span><span class="p">[</span><span class="s1">'T'</span><span class="p">]]))</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">Z</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">[</span><span class="n">idx_dict</span><span class="p">[</span><span class="s1">'Z'</span><span class="p">]]]</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">[</span><span class="n">idx_dict</span><span class="p">[</span><span class="s1">'T'</span><span class="p">]]]</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">[</span><span class="n">idx_dict</span><span class="p">[</span><span class="s1">'C'</span><span class="p">]]]</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">[</span><span class="n">idx_dict</span><span class="p">[</span><span class="s1">'Y'</span><span class="p">]]]</span>

<span class="n">corrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>

<span class="n">print_corr</span><span class="p">(</span><span class="s1">'C'</span><span class="p">,</span> <span class="s1">'T'</span><span class="p">,</span> <span class="n">corrs</span><span class="p">,</span> <span class="n">idx_dict</span><span class="p">)</span>
<span class="n">print_corr</span><span class="p">(</span><span class="s1">'C'</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">,</span> <span class="n">corrs</span><span class="p">,</span> <span class="n">idx_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We see what is exactly represented in our graph above: <span class="math notranslate nohighlight">\(C_{\text{SES}}\)</span> is correlated with both <span class="math notranslate nohighlight">\(T_{\text{smoking}}\)</span> and <span class="math notranslate nohighlight">\(Y_{\text{birthweight}}\)</span>, so <span class="math notranslate nohighlight">\(C_{\text{SES}}\)</span> is a potential confounder if not included in our analysis. Let’s say that it is difficult to observe and quantify <span class="math notranslate nohighlight">\(C_{\text{SES}}\)</span>, so we do not have it available to regress against. This is another example of the <strong>omitted variable bias</strong> we saw in the last tutorial.</p>
<p>What about <span class="math notranslate nohighlight">\(Z_{\text{taxes}}\)</span>? Does it satisfy conditions 1, 2, and 3 of an instrument?</p>
<p>Execute this cell to see correlations of Z</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#@markdown Execute this cell to see correlations of Z</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Condition 2?"</span><span class="p">)</span>
<span class="n">print_corr</span><span class="p">(</span><span class="s1">'Z'</span><span class="p">,</span> <span class="s1">'T'</span><span class="p">,</span> <span class="n">corrs</span><span class="p">,</span> <span class="n">idx_dict</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Condition 3?"</span><span class="p">)</span>
<span class="n">print_corr</span><span class="p">(</span><span class="s1">'Z'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">,</span> <span class="n">corrs</span><span class="p">,</span> <span class="n">idx_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Perfect! We see that <span class="math notranslate nohighlight">\(Z_{\text{taxes}}\)</span> is correlated with <span class="math notranslate nohighlight">\(T_{\text{smoking}}\)</span> (#2) but is uncorrelated with <span class="math notranslate nohighlight">\(C_{\text{SES}}\)</span> (#3).  <span class="math notranslate nohighlight">\(Z_\text{taxes}\)</span> is also observable (#1), so we’ve satisfied our three criteria for an instrument:</p>
<ol class="simple">
<li><p><span class="math notranslate nohighlight">\(Z_\text{taxes}\)</span> is observable</p></li>
<li><p><span class="math notranslate nohighlight">\(Z_\text{taxes}\)</span> affects <span class="math notranslate nohighlight">\(T_{\text{smoking}}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(Z_\text{taxes}\)</span> doesn’t affect <span class="math notranslate nohighlight">\(Y_{\text{birthweight}}\)</span> except through <span class="math notranslate nohighlight">\(T_{\text{smoking}}\)</span> (ie <span class="math notranslate nohighlight">\(Z_\text{taxes}\)</span> doesn’t affect or is affected by <span class="math notranslate nohighlight">\(C_\text{SES}\)</span>)</p></li>
</ol>
</div>
<div class="section" id="section-1-2-how-iv-works-at-high-level">
<h2>Section 1.2: How IV works, at high level<a class="headerlink" href="#section-1-2-how-iv-works-at-high-level" title="Permalink to this headline">¶</a></h2>
<p>The easiest way to imagine IV is that the instrument is <strong>an observable source of “randomness”</strong> that affects the treatment. In this way it’s similar to the interventions we talked about in Tutorial 1.</p>
<p>But how do you actually use the instrument? The key is that we need to extract <strong>the component of the treatment that is due only to the effect of the instrument</strong>. We will call this component <span class="math notranslate nohighlight">\(\hat{T}\)</span>.
$<span class="math notranslate nohighlight">\(
\hat{T}\leftarrow \text{The unconfounded component of }T
\)</span><span class="math notranslate nohighlight">\(
Getting \)</span>\hat{T}<span class="math notranslate nohighlight">\( is fairly simple. It is simply the predicted value of \)</span>T<span class="math notranslate nohighlight">\( found in a regression that has only the instrument \)</span>Z$ as input.</p>
<p>Once we have the unconfounded component in hand, getting the causal effect is as easy as regressing the outcome on <span class="math notranslate nohighlight">\(\hat{T}\)</span>.</p>
</div>
<div class="section" id="section-1-3-iv-estimation-using-two-stage-least-squares">
<h2>Section 1.3: IV estimation using two-stage least squares<a class="headerlink" href="#section-1-3-iv-estimation-using-two-stage-least-squares" title="Permalink to this headline">¶</a></h2>
<p>The fundamental technique for instrumental variable estimation is <strong>two-stage least squares</strong>.</p>
<p>We run two regressions:</p>
<ol class="simple">
<li><p>The first stage gets  <span class="math notranslate nohighlight">\(\hat{T}_{\text{smoking}}\)</span> by regressing <span class="math notranslate nohighlight">\(T_{\text{smoking}}\)</span> on <span class="math notranslate nohighlight">\(Z_\text{taxes}\)</span>, fitting the parameter <span class="math notranslate nohighlight">\(\hat{\alpha}\)</span>:</p></li>
</ol>
<div class="amsmath math notranslate nohighlight" id="equation-39bb41d5-41e1-4ad7-a3ba-865dcfa3312e">
<span class="eqno">(462)<a class="headerlink" href="#equation-39bb41d5-41e1-4ad7-a3ba-865dcfa3312e" title="Permalink to this equation">¶</a></span>\[\begin{equation}
\hat{T}_{\text{smoking}} = \hat{\alpha} Z_\text{taxes}
\end{equation}\]</div>
<ol class="simple">
<li><p>The second stage then regresses <span class="math notranslate nohighlight">\(Y_{\text{birthweight}}\)</span> on <span class="math notranslate nohighlight">\(\hat{T}_{\text{smoking}}\)</span> to obtain an estimate <span class="math notranslate nohighlight">\(\hat{\beta}\)</span> of the causal effect:</p></li>
</ol>
<div class="amsmath math notranslate nohighlight" id="equation-c4e1a480-4686-439a-93d5-040812662e5f">
<span class="eqno">(463)<a class="headerlink" href="#equation-c4e1a480-4686-439a-93d5-040812662e5f" title="Permalink to this equation">¶</a></span>\[\begin{equation}
\hat{Y}_{\text{birthweight}} = \hat{\beta} \hat{T}_{\text{smoking}} 
\end{equation}\]</div>
<p>The first stage estimates the <strong>unconfounded component</strong> of <span class="math notranslate nohighlight">\(T_{\text{smoking}}\)</span> (ie, unaffected by the confounder <span class="math notranslate nohighlight">\(C_{\text{SES}}\)</span>), as we discussed above.</p>
<p>Then, the second stage uses this unconfounded component <span class="math notranslate nohighlight">\(\hat{T}_{\text{smoking}}\)</span> to estimate the effect of smoking on <span class="math notranslate nohighlight">\(\hat{Y}_{\text{birthweight}}\)</span>.</p>
<p>We will explore how all this works in the next two exercises.</p>
<div class="section" id="section-1-3-1-least-squares-regression-stage-1">
<h3>Section 1.3.1: Least squares regression stage 1<a class="headerlink" href="#section-1-3-1-least-squares-regression-stage-1" title="Permalink to this headline">¶</a></h3>
<div class="section" id="video-2-stage-1">
<h4>Video 2: Stage 1<a class="headerlink" href="#video-2-stage-1" title="Permalink to this headline">¶</a></h4>
<div class="cell tag_remove-input docutils container">
</div>
</div>
<div class="section" id="coding-exercise-1-3-1-compute-regression-stage-1">
<h4>Coding Exercise 1.3.1: Compute regression stage 1<a class="headerlink" href="#coding-exercise-1-3-1-compute-regression-stage-1" title="Permalink to this headline">¶</a></h4>
<p>Let’s run the regression of <span class="math notranslate nohighlight">\(T_{\text{smoking}}\)</span> on <span class="math notranslate nohighlight">\(Z_\text{taxes}\)</span> to compute <span class="math notranslate nohighlight">\(\hat{T}_{\text{smoking}}\)</span>. We will then check whether our estimate is still confounded with <span class="math notranslate nohighlight">\(C_{\text{SES}}\)</span> by comparing the correlation of <span class="math notranslate nohighlight">\(C_{\text{SES}}\)</span>  with <span class="math notranslate nohighlight">\(T_{\text{smoking}}\)</span> vs <span class="math notranslate nohighlight">\(\hat{T}_{\text{smoking}}\)</span>.</p>
</div>
</div>
<div class="section" id="suggestions">
<h3>Suggestions<a class="headerlink" href="#suggestions" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>use the <code class="docutils literal notranslate"><span class="pre">LinearRegression()</span></code> model, already imported from scikit-learn</p>
<ul>
<li><p>use <code class="docutils literal notranslate"><span class="pre">fit_intercept=True</span></code> as the only parameter setting</p></li>
</ul>
</li>
<li><p>be sure to check the ordering of the parameters passed to <code class="docutils literal notranslate"><span class="pre">LinearRegression.fit()</span></code></p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="k">def</span> <span class="nf">fit_first_stage</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Estimates T_hat as the first stage of a two-stage least squares.</span>

<span class="sd">    Args:</span>
<span class="sd">        T (np.ndarray): our observed, possibly confounded, treatment of shape (n, 1)</span>
<span class="sd">        Z (np.ndarray): our observed instruments of shape (n, 1)</span>

<span class="sd">    Returns</span>
<span class="sd">        T_hat (np.ndarray): our estimate of the unconfounded portion of T</span>
<span class="sd">    """</span>

    <span class="c1">############################################################################</span>
    <span class="c1">## Insert your code here to fit the first stage of the 2-stage least squares</span>
    <span class="c1">## estimate.</span>
    <span class="c1">## Fill out function and remove</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">'Please complete fit_first_stage function'</span><span class="p">)</span>
    <span class="c1">############################################################################</span>

    <span class="c1"># Initialize linear regression model</span>
    <span class="n">stage1</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="c1"># Fit linear regression model</span>
    <span class="n">stage1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="c1"># Predict T_hat using linear regression model</span>
    <span class="n">T_hat</span> <span class="o">=</span> <span class="n">stage1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">T_hat</span>


<span class="c1"># Estimate T_hat</span>
<span class="n">T_hat</span> <span class="o">=</span> <span class="n">fit_first_stage</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>

<span class="c1"># Get correlations</span>
<span class="n">T_C_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">C</span><span class="o">.</span><span class="n">transpose</span><span class="p">())[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">T_hat_C_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">T_hat</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">C</span><span class="o">.</span><span class="n">transpose</span><span class="p">())[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># Print correlations</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Correlation between T and C: </span><span class="si">{:.3f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T_C_corr</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Correlation between T_hat and C: </span><span class="si">{:.3f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T_hat_C_corr</span><span class="p">))</span>

</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># to_remove solution</span>
<span class="k">def</span> <span class="nf">fit_first_stage</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Estimates T_hat as the first stage of a two-stage least squares.</span>

<span class="sd">    Args:</span>
<span class="sd">        T (np.ndarray): our observed, possibly confounded, treatment of shape (n, 1)</span>
<span class="sd">        Z (np.ndarray): our observed instruments of shape (n, 1)</span>

<span class="sd">    Returns</span>
<span class="sd">        T_hat (np.ndarray): our estimate of the unconfounded portion of T</span>
<span class="sd">    """</span>

    <span class="c1"># Initialize linear regression model</span>
    <span class="n">stage1</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Fit linear regression model</span>
    <span class="n">stage1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

    <span class="c1"># Predict T_hat using linear regression model</span>
    <span class="n">T_hat</span> <span class="o">=</span> <span class="n">stage1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">T_hat</span>


<span class="c1"># Estimate T_hat</span>
<span class="n">T_hat</span> <span class="o">=</span> <span class="n">fit_first_stage</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>

<span class="c1"># Get correlations</span>
<span class="n">T_C_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">C</span><span class="o">.</span><span class="n">transpose</span><span class="p">())[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">T_hat_C_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">T_hat</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">C</span><span class="o">.</span><span class="n">transpose</span><span class="p">())[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># Print correlations</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Correlation between T and C: </span><span class="si">{:.3f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T_C_corr</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Correlation between T_hat and C: </span><span class="si">{:.3f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T_hat_C_corr</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>You should see a correlation between <span class="math notranslate nohighlight">\(T\)</span> and <span class="math notranslate nohighlight">\(C\)</span> of <code class="docutils literal notranslate"><span class="pre">-0.483</span></code> and between <span class="math notranslate nohighlight">\(\hat{T}\)</span> and <span class="math notranslate nohighlight">\(C\)</span> of <code class="docutils literal notranslate"><span class="pre">0.009</span></code>.</p>
</div>
<div class="section" id="section-1-3-2-least-squares-regression-stage-2">
<h3>Section 1.3.2: Least squares regression stage 2<a class="headerlink" href="#section-1-3-2-least-squares-regression-stage-2" title="Permalink to this headline">¶</a></h3>
<div class="section" id="video-3-stage-2">
<h4>Video 3: Stage 2<a class="headerlink" href="#video-3-stage-2" title="Permalink to this headline">¶</a></h4>
<div class="cell tag_remove-input docutils container">
</div>
</div>
<div class="section" id="coding-exercise-1-3-2-compute-the-iv-estimate">
<h4>Coding Exercise 1.3.2: Compute the IV estimate<a class="headerlink" href="#coding-exercise-1-3-2-compute-the-iv-estimate" title="Permalink to this headline">¶</a></h4>
<p>Now let’s implement the second stage! Complete the <code class="docutils literal notranslate"><span class="pre">fit_second_stage()</span></code> function below. We will again use a linear regression model with an intercept. We will then use the function from Exercise 1 (<code class="docutils literal notranslate"><span class="pre">fit_first_stage</span></code>) and this function to estimate the full two-stage regression model. We will obtain the estimated causal effect of the number of cigarettes (<span class="math notranslate nohighlight">\(T\)</span>) on birth weight (<span class="math notranslate nohighlight">\(Y\)</span>).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="k">def</span> <span class="nf">fit_second_stage</span><span class="p">(</span><span class="n">T_hat</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Estimates a scalar causal effect from 2-stage least squares regression using</span>
<span class="sd">    an instrument.</span>

<span class="sd">    Args:</span>
<span class="sd">        T_hat (np.ndarray): the output of the first stage regression</span>
<span class="sd">        Y (np.ndarray): our observed response (n, 1)</span>

<span class="sd">    Returns:</span>
<span class="sd">        beta (float): the estimated causal effect</span>
<span class="sd">    """</span>
    <span class="c1">############################################################################</span>
    <span class="c1">## Insert your code here to fit the second stage of the 2-stage least squares</span>
    <span class="c1">## estimate.</span>
    <span class="c1">## Fill out function and remove</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">'Please complete fit_second_stage function'</span><span class="p">)</span>
    <span class="c1">############################################################################</span>

    <span class="c1"># Initialize linear regression model</span>
    <span class="n">stage2</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="c1"># Fit model to data</span>
    <span class="n">stage2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stage2</span><span class="o">.</span><span class="n">coef_</span>


<span class="c1"># Fit first stage</span>
<span class="n">T_hat</span> <span class="o">=</span> <span class="n">fit_first_stage</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>

<span class="c1"># Fit second stage</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">fit_second_stage</span><span class="p">(</span><span class="n">T_hat</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>

<span class="c1"># Print</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Estimated causal effect is: </span><span class="si">{:.3f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>

</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># to_remove solution</span>
<span class="k">def</span> <span class="nf">fit_second_stage</span><span class="p">(</span><span class="n">T_hat</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Estimates a scalar causal effect from 2-stage least squares regression using</span>
<span class="sd">    an instrument.</span>

<span class="sd">    Args:</span>
<span class="sd">        T_hat (np.ndarray): the output of the first stage regression</span>
<span class="sd">        Y (np.ndarray): our observed response (n, 1)</span>

<span class="sd">    Returns:</span>
<span class="sd">        beta (float): the estimated causal effect</span>
<span class="sd">    """</span>
    <span class="c1"># Initialize linear regression model</span>
    <span class="n">stage2</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Fit model to data</span>
    <span class="n">stage2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">T_hat</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stage2</span><span class="o">.</span><span class="n">coef_</span>


<span class="c1"># Fit first stage</span>
<span class="n">T_hat</span> <span class="o">=</span> <span class="n">fit_first_stage</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>

<span class="c1"># Fit second stage</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">fit_second_stage</span><span class="p">(</span><span class="n">T_hat</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>

<span class="c1"># Print</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Estimated causal effect is: </span><span class="si">{:.3f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<p>You should obtain an estimated causal effect of <code class="docutils literal notranslate"><span class="pre">-1.984</span></code>. This is quite close to the true causal effect of <span class="math notranslate nohighlight">\(-2\)</span>!</p>
</div>
</div>
</div>
</div>
<hr class="docutils"/>
<div class="section" id="section-2-ivs-in-our-simulated-neural-system">
<h1>Section 2: IVs in our simulated neural system<a class="headerlink" href="#section-2-ivs-in-our-simulated-neural-system" title="Permalink to this headline">¶</a></h1>
<p><em>Estimated timing to here from start of tutorial: 30 min</em></p>
<div class="section" id="video-4-ivs-in-simulated-neural-systems">
<h2>Video 4: IVs in simulated neural systems<a class="headerlink" href="#video-4-ivs-in-simulated-neural-systems" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_remove-input docutils container">
</div>
<p>Now, say we have the neural system we have been simulating, except with an additional variable <span class="math notranslate nohighlight">\(\vec{z}\)</span>. This will be our instrumental variable.</p>
<p>We treat <span class="math notranslate nohighlight">\(\vec{z}\)</span> as a source of noise in the dynamics of our neurons:</p>
<div class="amsmath math notranslate nohighlight" id="equation-057b59ce-c834-48c7-9cff-cfe874821372">
<span class="eqno">(464)<a class="headerlink" href="#equation-057b59ce-c834-48c7-9cff-cfe874821372" title="Permalink to this equation">¶</a></span>\[\begin{equation}
\vec{x}_{t+1} = \sigma(A\vec{x}_t + \eta \vec{z}_{t+1} + \epsilon_t)
\end{equation}\]</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\eta\)</span> is what we’ll call the “strength” of our IV</p></li>
<li><p><span class="math notranslate nohighlight">\(\vec{z}_t\)</span> is a random binary variable, <span class="math notranslate nohighlight">\(\vec{z}_t \sim Bernoulli(0.5)\)</span></p></li>
</ul>
<p>Remember that for each neuron <span class="math notranslate nohighlight">\(i\)</span>, we are trying to figure out whether <span class="math notranslate nohighlight">\(i\)</span> is connected to (causally affects) the other neurons in our system <em>at the next time step</em>. So for timestep <span class="math notranslate nohighlight">\(t\)</span>, we want to determine whether <span class="math notranslate nohighlight">\(\vec{x}_{i,t}\)</span> affects all the other neurons at <span class="math notranslate nohighlight">\(\vec{x}_{t+1}\)</span>. For a given neuron <span class="math notranslate nohighlight">\(i\)</span>, <span class="math notranslate nohighlight">\(\vec{z}_{i,t}\)</span> satisfies the 3 criteria for a valid instrument.</p>
<p><strong>What could <span class="math notranslate nohighlight">\(z\)</span> be, biologically?</strong></p>
<p>Imagine <span class="math notranslate nohighlight">\(z\)</span> to be some injected current through an <em>in vivo</em> patch clamp. It affects each neuron individually, and only affects dynamics through that neuron.</p>
<p>The cool thing about IV is that you don’t have to control <span class="math notranslate nohighlight">\(z\)</span> yourself - it can be observed. So if you mess up your wiring and accidentally connect the injected voltage to an AM radio, no worries. As long as you can observe the signal the method will work.</p>
<figure>
<img src="https://raw.githubusercontent.com/NeuromatchAcademy/course-content/main/tutorials/W3D5_NetworkCausality/static/neuron_iv.png"/>
</figure></div>
<div class="section" id="section-2-1-simulate-a-system-with-iv">
<h2>Section 2.1: Simulate a system with IV<a class="headerlink" href="#section-2-1-simulate-a-system-with-iv" title="Permalink to this headline">¶</a></h2>
<div class="section" id="coding-exercise-2-1-simulate-a-system-with-iv">
<h3>Coding Exercise 2.1: Simulate a system with IV<a class="headerlink" href="#coding-exercise-2-1-simulate-a-system-with-iv" title="Permalink to this headline">¶</a></h3>
<p>Here we’ll modify the function that simulates the neural system, but this time make the update rule include the effect of the instrumental variable <span class="math notranslate nohighlight">\(z\)</span>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="k">def</span> <span class="nf">simulate_neurons_iv</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Simulates a dynamical system for the specified number of neurons and timesteps.</span>

<span class="sd">    Args:</span>
<span class="sd">        n_neurons (int): the number of neurons in our system.</span>
<span class="sd">        timesteps (int): the number of timesteps to simulate our system.</span>
<span class="sd">        eta (float): the strength of the instrument</span>
<span class="sd">        random_state (int): seed for reproducibility</span>

<span class="sd">    Returns:</span>
<span class="sd">        The tuple (A,X,Z) of the connectivity matrix, simulated system, and instruments.</span>
<span class="sd">        - A has shape (n_neurons, n_neurons)</span>
<span class="sd">        - X has shape (n_neurons, timesteps)</span>
<span class="sd">        - Z has shape (n_neurons, timesteps)</span>
<span class="sd">    """</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">create_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">))</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">timesteps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>

      <span class="c1">############################################################################</span>
      <span class="c1">## Insert your code here to adjust the update rule to include the</span>
      <span class="c1">## instrumental variable.</span>
      <span class="c1">##  We've already created Z for you. (We need to return it to regress on it).</span>
      <span class="c1">##  Your task is to slice it appropriately. Don't forget eta.</span>
      <span class="c1">## Fill out function and remove</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">'Complete simulate_neurons_iv function'</span><span class="p">)</span>
      <span class="c1">############################################################################</span>

      <span class="n">IV_on_this_timestep</span> <span class="o">=</span> <span class="o">...</span>

      <span class="n">X</span><span class="p">[:,</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">t</span><span class="p">])</span> <span class="o">+</span> <span class="n">IV_on_this_timestep</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Z</span>


<span class="c1"># Set parameters</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">5000</span>  <span class="c1"># Simulate for 5000 timesteps.</span>
<span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># the size of our system</span>
<span class="n">eta</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># the strength of our instrument, higher is stronger</span>

<span class="c1"># Simulate our dynamical system for the given amount of time</span>
<span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">simulate_neurons_iv</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span>

<span class="c1"># Visualize</span>
<span class="n">plot_neural_activity</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># to_remove solution</span>
<span class="k">def</span> <span class="nf">simulate_neurons_iv</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Simulates a dynamical system for the specified number of neurons and timesteps.</span>

<span class="sd">    Args:</span>
<span class="sd">        n_neurons (int): the number of neurons in our system.</span>
<span class="sd">        timesteps (int): the number of timesteps to simulate our system.</span>
<span class="sd">        eta (float): the strength of the instrument</span>
<span class="sd">        random_state (int): seed for reproducibility</span>

<span class="sd">    Returns:</span>
<span class="sd">        The tuple (A,X,Z) of the connectivity matrix, simulated system, and instruments.</span>
<span class="sd">        - A has shape (n_neurons, n_neurons)</span>
<span class="sd">        - X has shape (n_neurons, timesteps)</span>
<span class="sd">        - Z has shape (n_neurons, timesteps)</span>
<span class="sd">    """</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">create_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">))</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">timesteps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>

      <span class="n">IV_on_this_timestep</span> <span class="o">=</span> <span class="p">(</span><span class="n">eta</span> <span class="o">*</span> <span class="n">Z</span><span class="p">[:,</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

      <span class="n">X</span><span class="p">[:,</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">t</span><span class="p">])</span> <span class="o">+</span> <span class="n">IV_on_this_timestep</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Z</span>


<span class="c1"># Set parameters</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">5000</span>  <span class="c1"># Simulate for 5000 timesteps.</span>
<span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># the size of our system</span>
<span class="n">eta</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># the strength of our instrument, higher is stronger</span>

<span class="c1"># Simulate our dynamical system for the given amount of time</span>
<span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">simulate_neurons_iv</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span>

<span class="c1"># Visualize</span>
<span class="k">with</span> <span class="n">plt</span><span class="o">.</span><span class="n">xkcd</span><span class="p">():</span>
  <span class="n">plot_neural_activity</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="section-2-2-estimate-iv-for-simulated-neural-system">
<h2>Section 2.2: Estimate IV for simulated neural system<a class="headerlink" href="#section-2-2-estimate-iv-for-simulated-neural-system" title="Permalink to this headline">¶</a></h2>
<p>Since you just implemented two-stage least squares, we’ve provided the network implementation for you, with the function <code class="docutils literal notranslate"><span class="pre">get_iv_estimate_network()</span></code>. Now, let’s see how our IV estimates do in recovering the connectivity matrix.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_iv_estimate_network</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Estimates the connectivity matrix from 2-stage least squares regression</span>
<span class="sd">    using an instrument.</span>

<span class="sd">    Args:</span>
<span class="sd">        X (np.ndarray): our simulated system of shape (n_neurons, timesteps)</span>
<span class="sd">        Z (np.ndarray): our observed instruments of shape (n_neurons, timesteps)</span>

<span class="sd">    Returns:</span>

<span class="sd">        V (np.ndarray): the estimated connectivity matrix</span>
<span class="sd">    """</span>
    <span class="n">n_neurons</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

    <span class="c1"># apply inverse sigmoid transformation</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">logit</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>

    <span class="c1"># Stage 1: regress X on Z</span>
    <span class="n">stage1</span> <span class="o">=</span> <span class="n">MultiOutputRegressor</span><span class="p">(</span><span class="n">LinearRegression</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">stage1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Z</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
    <span class="n">X_hat</span> <span class="o">=</span> <span class="n">stage1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Z</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>

    <span class="c1"># Stage 2: regress Y on X_hatI</span>
    <span class="n">stage2</span> <span class="o">=</span> <span class="n">MultiOutputRegressor</span><span class="p">(</span><span class="n">LinearRegression</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">stage2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_hat</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>

    <span class="c1"># Get estimated effects</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">estimator</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stage2</span><span class="o">.</span><span class="n">estimators_</span><span class="p">):</span>
        <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">coef_</span>

    <span class="k">return</span> <span class="n">V</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s see how well it works in our system.</p>
<p>Execute this cell to visualize IV estimated connectivity matrix</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#@markdown Execute this cell to visualize IV estimated connectivity matrix</span>
<span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">eta</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">simulate_neurons_iv</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">get_iv_estimate_network</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"IV estimated correlation: </span><span class="si">{:.3f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">V</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"coolwarm"</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s2">"True connectivity matrix"</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">'Connectivity from'</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">'Connectivity to'</span><span class="p">)</span>

<span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"coolwarm"</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s2">"IV estimated connectivity matrix"</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">'Connectivity from'</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The IV estimates seem to perform pretty well! In the next section, we will see how they behave in the face of omitted variable bias.</p>
</div>
</div>
<hr class="docutils"/>
<div class="section" id="section-3-ivs-and-omitted-variable-bias">
<h1>Section 3: IVs and omitted variable bias<a class="headerlink" href="#section-3-ivs-and-omitted-variable-bias" title="Permalink to this headline">¶</a></h1>
<p><em>Estimated timing to here from start of tutorial: 40 min</em></p>
<div class="section" id="video-5-iv-vs-regression">
<h2>Video 5: IV vs regression<a class="headerlink" href="#video-5-iv-vs-regression" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_remove-input docutils container">
</div>
</div>
<div class="section" id="interactive-demo-3-estimating-connectivity-with-iv-vs-regression-on-a-subset-of-observed-neurons">
<h2>Interactive Demo 3: Estimating connectivity with IV vs regression on a subset of observed neurons<a class="headerlink" href="#interactive-demo-3-estimating-connectivity-with-iv-vs-regression-on-a-subset-of-observed-neurons" title="Permalink to this headline">¶</a></h2>
<p>Change the ratio of observed neurons and look at the impact on the quality of connectivity estimation using IV vs regression. Which method does better with fewer observed neurons?</p>
<p>Execute this cell to enable demo. This simulation will take about a minute to run!</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @markdown Execute this cell to enable demo. This simulation will take about a minute to run!</span>
<span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">20000</span>
<span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">eta</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">simulate_neurons_iv</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>


<span class="n">reg_args</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"fit_intercept"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">"alpha"</span><span class="p">:</span> <span class="mf">0.001</span>
<span class="p">}</span>

<span class="nd">@widgets</span><span class="o">.</span><span class="n">interact</span>
<span class="k">def</span> <span class="nf">plot_observed</span><span class="p">(</span><span class="n">ratio</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]):</span>
  <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
  <span class="n">sel_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ratio</span> <span class="o">*</span> <span class="n">n_neurons</span><span class="p">)</span>
  <span class="n">n_observed</span> <span class="o">=</span> <span class="n">sel_idx</span>
  <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">))</span>
  <span class="n">offset</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:</span><span class="n">sel_idx</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">1</span> <span class="o">+</span> <span class="n">A</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:</span><span class="n">sel_idx</span><span class="p">]</span>
  <span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"coolwarm"</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s2">"True connectivity"</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Connectivity to"</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Connectivity from"</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>

  <span class="n">sel_A</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:</span><span class="n">sel_idx</span><span class="p">]</span>
  <span class="n">sel_X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:]</span>
  <span class="n">sel_Z</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:]</span>

  <span class="n">V</span> <span class="o">=</span> <span class="n">get_iv_estimate_network</span><span class="p">(</span><span class="n">sel_X</span><span class="p">,</span> <span class="n">sel_Z</span><span class="p">)</span>
  <span class="n">iv_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">sel_A</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">V</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

  <span class="n">big_V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
  <span class="n">big_V</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:</span><span class="n">sel_idx</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">1</span> <span class="o">+</span> <span class="n">V</span>

  <span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">big_V</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"coolwarm"</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
  <span class="n">c</span> <span class="o">=</span> <span class="s1">'w'</span> <span class="k">if</span> <span class="n">n_observed</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">n_neurons</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="k">else</span> <span class="s1">'k'</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_observed</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"Correlation : </span><span class="si">{:.2f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iv_corr</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>


  <span class="n">reg_corr</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">get_regression_corr_full_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span>
                                  <span class="n">A</span><span class="p">,</span>
                                  <span class="n">X</span><span class="p">,</span>
                                  <span class="n">ratio</span><span class="p">,</span>
                                  <span class="n">reg_args</span><span class="p">)</span>


  <span class="n">big_R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
  <span class="n">big_R</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:</span><span class="n">sel_idx</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">1</span> <span class="o">+</span> <span class="n">R</span>

  <span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">big_R</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"coolwarm"</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
  <span class="n">c</span> <span class="o">=</span> <span class="s1">'w'</span> <span class="k">if</span> <span class="n">n_observed</span><span class="o">&lt;</span><span class="p">(</span><span class="n">n_neurons</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="k">else</span> <span class="s1">'k'</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s2">"Estimated connectivity (IV)"</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Connectivity to"</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Connectivity from"</span><span class="p">)</span>

  <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_observed</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span><span class="s2">"Correlation : </span><span class="si">{:.2f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_corr</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s2">"Estimated connectivity (regression)"</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Connectivity to"</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Connectivity from"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can also visualize the performance of regression and IV as a function of the observed neuron ratio below.</p>
<p><strong>Note</strong> that this code takes about a minute to run!</p>
<p>Execute this cell to visualize connectivity estimation performance</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @markdown Execute this cell to visualize connectivity estimation performance</span>
<span class="k">def</span> <span class="nf">compare_iv_estimate_to_regression</span><span class="p">(</span><span class="n">observed_ratio</span><span class="p">):</span>
<span class="w">  </span><span class="sd">"""</span>
<span class="sd">  A wrapper function to compare IV and Regressor performance as a function of observed neurons</span>

<span class="sd">  Args:</span>
<span class="sd">        observed_ratio(list): a list of different observed ratios (out of the whole system)</span>
<span class="sd">  """</span>

  <span class="c1">#Let's compare IV estimates to our regression estimates, uncomment the code below</span>

  <span class="n">reg_corrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">observed_ratio</span><span class="p">),))</span>
  <span class="n">iv_corrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">observed_ratio</span><span class="p">),))</span>
  <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">observed_ratio</span><span class="p">):</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
      <span class="n">sel_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ratio</span> <span class="o">*</span> <span class="n">n_neurons</span><span class="p">)</span>

      <span class="n">sel_X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:]</span>
      <span class="n">sel_Z</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:]</span>
      <span class="n">sel_A</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:</span><span class="n">sel_idx</span><span class="p">]</span>

      <span class="n">sel_reg_V</span> <span class="o">=</span> <span class="n">get_regression_estimate</span><span class="p">(</span><span class="n">sel_X</span><span class="p">)</span>
      <span class="n">reg_corrs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">sel_A</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">sel_reg_V</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

      <span class="n">sel_iv_V</span> <span class="o">=</span> <span class="n">get_iv_estimate_network</span><span class="p">(</span><span class="n">sel_X</span><span class="p">,</span> <span class="n">sel_Z</span><span class="p">)</span>
      <span class="n">iv_corrs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">sel_A</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">sel_iv_V</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

  <span class="c1"># Plotting IV vs lasso performance</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">observed_ratio</span><span class="p">,</span> <span class="n">reg_corrs</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">observed_ratio</span><span class="p">,</span> <span class="n">iv_corrs</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Connectivity matrices correlation with truth"</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Fraction of observed variables"</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"IV and lasso performance as a function of observed neuron ratio"</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">'Regression'</span><span class="p">,</span> <span class="s1">'IV'</span><span class="p">])</span>

<span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">40</span>  <span class="c1"># the size of the system</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">20000</span>
<span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">eta</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># the strength of our instrument</span>

<span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">simulate_neurons_iv</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>

<span class="n">observed_ratio</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>

<span class="n">compare_iv_estimate_to_regression</span><span class="p">(</span><span class="n">observed_ratio</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We see that IVs handle omitted variable bias (when the instrument is strong and we have enough data).</p>
<p><strong>The costs of IV analysis</strong></p>
<ul class="simple">
<li><p>we need to find an appropriate and valid instrument</p></li>
<li><p>Because of the 2-stage estimation process, we need strong instruments or else our standard errors will be large</p></li>
</ul>
</div>
</div>
<hr class="docutils"/>
<div class="section" id="section-4-thinking-about-causality-in-your-work">
<h1>Section 4: Thinking about causality in your work<a class="headerlink" href="#section-4-thinking-about-causality-in-your-work" title="Permalink to this headline">¶</a></h1>
<p><em>Estimated timing to here from start of tutorial: 50 min</em></p>
<div class="section" id="think-4-discussion-questions">
<h2>Think 4!: Discussion questions<a class="headerlink" href="#think-4-discussion-questions" title="Permalink to this headline">¶</a></h2>
<p>Please discuss the following in groups for around 10 minutes.</p>
<ul class="simple">
<li><p>Think back to your most recent work. Can you create a causal diagram of the fundamental question? Are there sources of bias (omitted variables or otherwise) that might be a threat to causal validity?</p></li>
<li><p>Can you think of any possibilities for instrumental variables? What sources of observed randomness could studies in your field leverage in identifying causal effects?</p></li>
</ul>
</div>
</div>
<hr class="docutils"/>
<div class="section" id="summary">
<h1>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h1>
<p><em>Estimated timing of tutorial: 1 hour, 5 min</em></p>
<div class="section" id="video-6-summary">
<h2>Video 6: Summary<a class="headerlink" href="#video-6-summary" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_remove-input docutils container">
</div>
<p>In this tutorial, we:</p>
<ul class="simple">
<li><p>Explored instrumental variables and how we can use them for causality estimates</p></li>
<li><p>Compared IV estimates to regression estimates</p></li>
</ul>
</div>
</div>
<hr class="docutils"/>
<div class="section" id="bonus">
<h1>Bonus<a class="headerlink" href="#bonus" title="Permalink to this headline">¶</a></h1>
<hr class="docutils"/>
<div class="section" id="bonus-section-1-exploring-instrument-strength">
<h2>Bonus Section 1: Exploring Instrument Strength<a class="headerlink" href="#bonus-section-1-exploring-instrument-strength" title="Permalink to this headline">¶</a></h2>
<div class="section" id="bonus-exercise-1-exploring-instrument-strength">
<h3>Bonus Exercise 1: Exploring instrument strength<a class="headerlink" href="#bonus-exercise-1-exploring-instrument-strength" title="Permalink to this headline">¶</a></h3>
<p>Explore how the strength of the instrument <span class="math notranslate nohighlight">\(\eta\)</span> affects the quality of estimates with instrumental variables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">instrument_strength_effect</span><span class="p">(</span><span class="n">etas</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">):</span>
<span class="w">  </span><span class="sd">""" Compute IV estimation performance for different instrument strengths</span>

<span class="sd">  Args:</span>
<span class="sd">    etas (list): different instrument strengths to compare</span>
<span class="sd">    n_neurons (int): number of neurons in simulation</span>
<span class="sd">    timesteps (int): number of timesteps in simulation</span>
<span class="sd">    n_trials (int): number of trials to compute</span>

<span class="sd">  Returns:</span>
<span class="sd">    ndarray: n_trials x len(etas) array where each element is the correlation</span>
<span class="sd">        between true and estimated connectivity matrices for that trial and</span>
<span class="sd">        instrument strength</span>
<span class="sd">  """</span>

  <span class="c1"># Initialize corr array</span>
  <span class="n">corr_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_trials</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">etas</span><span class="p">)))</span>

  <span class="c1"># Loop over trials</span>
  <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_trials</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Trial </span><span class="si">{}</span><span class="s2"> of </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trial</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">))</span>

    <span class="c1"># Loop over instrument strengths</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">eta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">etas</span><span class="p">):</span>
      <span class="c1">########################################################################</span>
      <span class="c1">## TODO: Simulate system with a given instrument strength, get IV estimate,</span>
      <span class="c1">## and compute correlation</span>
      <span class="c1"># Fill out function and remove</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">'Student exercise: complete instrument_strength_effect'</span><span class="p">)</span>
      <span class="c1">########################################################################</span>

      <span class="c1"># Simulate system</span>
      <span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">simulate_neurons_iv</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

      <span class="c1"># Compute IV estimate</span>
      <span class="n">iv_V</span> <span class="o">=</span> <span class="n">get_iv_estimate_network</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

      <span class="c1"># Compute correlation</span>
      <span class="n">corr_data</span><span class="p">[</span><span class="n">trial</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">iv_V</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

  <span class="k">return</span> <span class="n">corr_data</span>


<span class="c1"># Parameters of system</span>
<span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">n_trials</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">etas</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">]</span>  <span class="c1"># instrument strengths to search over</span>

<span class="c1"># Get IV estimate performances</span>
<span class="n">corr_data</span> <span class="o">=</span> <span class="n">instrument_strength_effect</span><span class="p">(</span><span class="n">etas</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">)</span>

<span class="c1"># Visualize</span>
<span class="n">plot_performance_vs_eta</span><span class="p">(</span><span class="n">etas</span><span class="p">,</span> <span class="n">corr_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># to_remove_solution</span>
<span class="k">def</span> <span class="nf">instrument_strength_effect</span><span class="p">(</span><span class="n">etas</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">):</span>
<span class="w">  </span><span class="sd">""" Compute IV estimation performance for different instrument strengths</span>

<span class="sd">  Args:</span>
<span class="sd">    etas (list): different instrument strengths to compare</span>
<span class="sd">    n_neurons (int): number of neurons in simulation</span>
<span class="sd">    timesteps (int): number of timesteps in simulation</span>
<span class="sd">    n_trials (int): number of trials to compute</span>

<span class="sd">  Returns:</span>
<span class="sd">    ndarray: n_trials x len(etas) array where each element is the correlation</span>
<span class="sd">        between true and estimated connectivity matrices for that trial and</span>
<span class="sd">        instrument strength</span>
<span class="sd">  """</span>

  <span class="c1"># Initialize corr array</span>
  <span class="n">corr_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_trials</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">etas</span><span class="p">)))</span>

  <span class="c1"># Loop over trials</span>
  <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_trials</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Trial </span><span class="si">{}</span><span class="s2"> of </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trial</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">))</span>

    <span class="c1"># Loop over instrument strengths</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">eta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">etas</span><span class="p">):</span>

      <span class="c1"># Simulate system</span>
      <span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">simulate_neurons_iv</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span>

      <span class="c1"># Compute IV estimate</span>
      <span class="n">iv_V</span> <span class="o">=</span> <span class="n">get_iv_estimate_network</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>

      <span class="c1"># Compute correlation</span>
      <span class="n">corr_data</span><span class="p">[</span><span class="n">trial</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">iv_V</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

  <span class="k">return</span> <span class="n">corr_data</span>


<span class="c1"># Parameters of system</span>
<span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">n_trials</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">etas</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">]</span>  <span class="c1"># instrument strengths to search over</span>

<span class="c1"># Get IV estimate performances</span>
<span class="n">corr_data</span> <span class="o">=</span> <span class="n">instrument_strength_effect</span><span class="p">(</span><span class="n">etas</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">)</span>

<span class="c1"># Visualize</span>
<span class="k">with</span> <span class="n">plt</span><span class="o">.</span><span class="n">xkcd</span><span class="p">():</span>
  <span class="n">plot_performance_vs_eta</span><span class="p">(</span><span class="n">etas</span><span class="p">,</span> <span class="n">corr_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<hr class="docutils"/>
<div class="section" id="bonus-section-2-granger-causality">
<h2>Bonus Section 2: Granger Causality<a class="headerlink" href="#bonus-section-2-granger-causality" title="Permalink to this headline">¶</a></h2>
<p>Another potential solution to temporal causation that we might consider: <a class="reference external" href="https://en.wikipedia.org/wiki/Granger_causality"><em>Granger Causality</em></a>.</p>
<p>But, like the simultaneous fitting we explored in Tutorial 3, this method still fails in the presence of unobserved variables.</p>
<p>We are testing whether a time series <span class="math notranslate nohighlight">\(X\)</span> Granger-causes a time series <span class="math notranslate nohighlight">\(Y\)</span> through a hypothesis test:</p>
<ul class="simple">
<li><p>the null hypothesis <span class="math notranslate nohighlight">\(H_0\)</span>: lagged values of <span class="math notranslate nohighlight">\(X\)</span> do not help predict values of <span class="math notranslate nohighlight">\(Y\)</span></p></li>
<li><p>the alternative hypothesis <span class="math notranslate nohighlight">\(H_a\)</span>: lagged values of <span class="math notranslate nohighlight">\(X\)</span> <strong>do</strong> help predict values of <span class="math notranslate nohighlight">\(Y\)</span></p></li>
</ul>
<p>Mechanically, this is accomplished by fitting autoregressive models for <span class="math notranslate nohighlight">\(y_{t}\)</span>. We fail to reject the hypothesis if none of the <span class="math notranslate nohighlight">\(x_{t-k}\)</span> terms are retained as significant in the regression. For simplicity, we will consider only one time lag. So, we have:</p>
<div class="amsmath math notranslate nohighlight" id="equation-92c00135-311d-4104-9708-02f15a7d88c1">
<span class="eqno">(465)<a class="headerlink" href="#equation-92c00135-311d-4104-9708-02f15a7d88c1" title="Permalink to this equation">¶</a></span>\[\begin{align}
H_0: y_t &amp;= a_0 + a_1 y_{t-1} +\epsilon_t \\
H_a: y_t &amp;= a_0 + a_1 y_{t-1} + b_1 x_{t-1} +\epsilon_t
\end{align}\]</div>
<p>Execute this cell to get custom imports from stats models</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @markdown Execute this cell to get custom imports from stats models</span>
<span class="c1"># we need custom imports from stats models</span>
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>statsmodels<span class="w"> </span>--quiet
<span class="kn">from</span> <span class="nn">statsmodels.tsa.stattools</span> <span class="kn">import</span> <span class="n">grangercausalitytests</span>
<span class="kn">import</span> <span class="nn">pandas.util.testing</span> <span class="k">as</span> <span class="nn">tm</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="bonus-section-2-1-granger-causality-in-small-systems">
<h3>Bonus Section 2.1: Granger causality in small systems<a class="headerlink" href="#bonus-section-2-1-granger-causality-in-small-systems" title="Permalink to this headline">¶</a></h3>
<p>We will first evaluate Granger causality in a small system.</p>
<div class="section" id="bonus-coding-exercise-2-1-evaluate-granger-causality">
<h4>Bonus Coding Exercise 2.1: Evaluate Granger causality<a class="headerlink" href="#bonus-coding-exercise-2-1-evaluate-granger-causality" title="Permalink to this headline">¶</a></h4>
<p>Complete the following definition to evaluate the Granger causality between our neurons. Then run the cells below to evaluate how well it works. You will use the <code class="docutils literal notranslate"><span class="pre">grangercausalitytests()</span></code> function already imported from statsmodels. We will then check whether a neuron in a small system Granger-causes the others.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="k">def</span> <span class="nf">get_granger_causality</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
<span class="w">  </span><span class="sd">"""</span>
<span class="sd">  Estimates the lag-1 granger causality of the given neuron on the other neurons in the system.</span>

<span class="sd">  Args:</span>
<span class="sd">      X (np.ndarray): the matrix holding our dynamical system of shape (n_neurons, timesteps)</span>
<span class="sd">      selected_neuron (int): the index of the neuron we want to estimate granger causality for</span>
<span class="sd">      alpha (float): Bonferroni multiple comparisons correction</span>

<span class="sd">  Returns:</span>
<span class="sd">      A tuple (reject_null, p_vals)</span>
<span class="sd">      reject_null (list): a binary list of length n_neurons whether the null was</span>
<span class="sd">          rejected for the selected neuron granger causing the other neurons</span>
<span class="sd">      p_vals (list): a list of the p-values for the corresponding Granger causality tests</span>
<span class="sd">  """</span>
  <span class="n">n_neurons</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">max_lag</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="n">reject_null</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">p_vals</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">for</span> <span class="n">target_neuron</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">):</span>
    <span class="n">ts_data</span> <span class="o">=</span> <span class="n">X</span><span class="p">[[</span><span class="n">target_neuron</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

    <span class="c1">########################################################################</span>
    <span class="c1">## Insert your code here to run Granger causality tests.</span>
    <span class="c1">##</span>
    <span class="c1">## Function Hints:</span>
    <span class="c1">##     Pass the ts_data defined above as the first argument</span>
    <span class="c1">##     Granger causality -&gt; grangercausalitytests</span>
    <span class="c1">## Fill out this function and then remove</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">'Student exercise: complete get_granger_causality function'</span><span class="p">)</span>
    <span class="c1">########################################################################</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">grangercausalitytests</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="c1"># Gets the p-value for the log-ratio test</span>
    <span class="n">pval</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'lrtest'</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">p_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pval</span><span class="p">)</span>
    <span class="n">reject_null</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pval</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">))</span>

  <span class="k">return</span> <span class="n">reject_null</span><span class="p">,</span> <span class="n">p_vals</span>


<span class="c1"># Set up small system</span>
<span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">selected_neuron</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">create_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">simulate_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>

<span class="c1"># Estimate Granger causality</span>
<span class="n">reject_null</span><span class="p">,</span> <span class="n">p_vals</span> <span class="o">=</span> <span class="n">get_granger_causality</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">)</span>

<span class="c1"># Visualize</span>
<span class="n">compare_granger_connectivity</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">reject_null</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">)</span>

</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># to_remove solution</span>
<span class="k">def</span> <span class="nf">get_granger_causality</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
<span class="w">  </span><span class="sd">"""</span>
<span class="sd">  Estimates the lag-1 granger causality of the given neuron on the other neurons in the system.</span>

<span class="sd">  Args:</span>
<span class="sd">      X (np.ndarray): the matrix holding our dynamical system of shape (n_neurons, timesteps)</span>
<span class="sd">      selected_neuron (int): the index of the neuron we want to estimate granger causality for</span>
<span class="sd">      alpha (float): Bonferroni multiple comparisons correction</span>

<span class="sd">  Returns:</span>
<span class="sd">      A tuple (reject_null, p_vals)</span>
<span class="sd">      reject_null (list): a binary list of length n_neurons whether the null was</span>
<span class="sd">          rejected for the selected neuron granger causing the other neurons</span>
<span class="sd">      p_vals (list): a list of the p-values for the corresponding Granger causality tests</span>
<span class="sd">  """</span>
  <span class="n">n_neurons</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">max_lag</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="n">reject_null</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">p_vals</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">for</span> <span class="n">target_neuron</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">):</span>
    <span class="n">ts_data</span> <span class="o">=</span> <span class="n">X</span><span class="p">[[</span><span class="n">target_neuron</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">grangercausalitytests</span><span class="p">(</span><span class="n">ts_data</span><span class="p">,</span> <span class="n">maxlag</span><span class="o">=</span><span class="n">max_lag</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Gets the p-value for the log-ratio test</span>
    <span class="n">pval</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'lrtest'</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">p_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pval</span><span class="p">)</span>
    <span class="n">reject_null</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pval</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">))</span>

  <span class="k">return</span> <span class="n">reject_null</span><span class="p">,</span> <span class="n">p_vals</span>


<span class="c1"># Set up small system</span>
<span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">selected_neuron</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">create_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">simulate_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>

<span class="c1"># Estimate Granger causality</span>
<span class="n">reject_null</span><span class="p">,</span> <span class="n">p_vals</span> <span class="o">=</span> <span class="n">get_granger_causality</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">)</span>

<span class="c1"># Visualize</span>
<span class="k">with</span> <span class="n">plt</span><span class="o">.</span><span class="n">xkcd</span><span class="p">():</span>
  <span class="n">compare_granger_connectivity</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">reject_null</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Looks good! Let’s also check the correlation between Granger estimates and the true connectivity.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">A</span><span class="p">[:,</span><span class="n">selected_neuron</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reject_null</span><span class="p">))[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>When we have a small system, we correctly identify the causality of neuron 1.</p>
</div>
</div>
<div class="section" id="bonus-section-2-2-granger-causality-in-large-systems">
<h3>Bonus Section 2.2: Granger causality in large systems<a class="headerlink" href="#bonus-section-2-2-granger-causality-in-large-systems" title="Permalink to this headline">¶</a></h3>
<p>We will now run Granger causality on a large system with 100 neurons. Does it still work well? How does the number of timesteps matter?</p>
<p>Execute this cell to examine Granger causality in a large system</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @markdown Execute this cell to examine Granger causality in a large system</span>
<span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">selected_neuron</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">create_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">simulate_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>

<span class="c1"># get granger causality estimates</span>
<span class="n">reject_null</span><span class="p">,</span> <span class="n">p_vals</span> <span class="o">=</span> <span class="n">get_granger_causality</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">)</span>
<span class="n">compare_granger_connectivity</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">reject_null</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s again check the correlation between the Granger estimates and the true connectivity. Are we able to recover the true connectivity well in this larger system?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">A</span><span class="p">[:,</span><span class="n">selected_neuron</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reject_null</span><span class="p">))[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Notes on Granger Causality</strong></p>
<p>Here we considered bivariate Granger causality – for each pair of neurons <span class="math notranslate nohighlight">\(A, B\)</span>, does one Granger-cause the other? You might wonder whether considering more variables will help with estimation. <em>Conditional Granger Causality</em> is a technique that allows for a multivariate system, where we test whether <span class="math notranslate nohighlight">\(A\)</span> Granger-causes <span class="math notranslate nohighlight">\(B\)</span> conditional on the other variables in the system.</p>
<p>Even after controlling for variables in the system, conditional Granger causality will also likely perform poorly as our system gets larger. Plus, measuring the additional variables to condition on may be infeasible in practical applications, which would introduce omitted variable bias as we saw in the regression exercise.</p>
<p>One takeaway here is that as our estimation procedures become more sophisticated, they also become more difficult to interpret. We always need to understand the methods and the assumptions that are made.</p>
</div>
</div>
</div>
<script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./tutorials/W3D5_NetworkCausality/instructor"
        },
        predefinedOutput: true
    }
    </script>
<script>kernelName = 'python3'</script>
</div>
</main>
<footer class="footer-article noprint">
<!-- Previous / next buttons -->
<div class="prev-next-area">
<a class="left-prev" href="W3D5_Tutorial3.html" id="prev-link" title="previous page">
<i class="fas fa-angle-left"></i>
<div class="prev-next-info">
<p class="prev-next-subtitle">previous</p>
<p class="prev-next-title">Tutorial 3: Simultaneous fitting/regression</p>
</div>
</a>
<a class="right-next" href="W3D5_Outro.html" id="next-link" title="next page">
<div class="prev-next-info">
<p class="prev-next-subtitle">next</p>
<p class="prev-next-title">Outro</p>
</div>
<i class="fas fa-angle-right"></i>
</a>
</div>
</footer>
</div>
</div>
<div class="footer-content row">
<footer class="col footer"><p>
  
    By Neuromatch<br/>
<div class="extra_footer">
<div>
<a href="http://creativecommons.org/licenses/by/4.0/"><img src="https://i.creativecommons.org/l/by/4.0/88x31.png"/></a>
<a href="https://opensource.org/licenses/BSD-3-Clause"><img src="https://camo.githubusercontent.com/9b9ea65d95c9ef878afa1987df65731d47681336/68747470733a2f2f696d672e736869656c64732e696f2f707970692f6c2f736561626f726e2e737667"/></a>
The contents of this repository are shared under the <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
Software elements are additionally licensed under the <a href="https://opensource.org/licenses/BSD-3-Clause">BSD (3-Clause) License</a>.
</div>
</div>
</p>
</footer>
</div>
</div>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
</body>
</html>